---
title: 'Gerrymandering: Exploring the Data'
author: "An, Anderson, and Deck"
date: "4/4/2021"
output: pdf_document
---

We are interested in a more reasonable naming device to provide a better way to think about each map. 

For the gerrymandered maps we refer to them as $Gerry_i$ for $i \in \{A,B\}$ where $i$ identifies the player for whom the map is gerrymandered (Player A is advantaged in $Gerry_A$). That is, Map 1 will be $Gerry_B$ and Map 5 will be $Gerry_A$.

As the remaining maps are symmetric at the player level we reference $Sym_{d,z}$ for $d \in \{1,3\}$ and $z \in \{1,3\}$ where $d$ denotes the number of competitive districts and $z$ denotes the number of zones within each competitive district. That is, Map 2 will be $Sym_{1,1}$, Map 3 will be $Sym_{1,3}$, and Map 4 will be $Sym_{3,1}$.

For reference:

![]("Maps_Image")

Reading from left to right we have Gerry_B, Symm_1_1, Symm_1_3, Symm_3_1, and Gerry_A.

```{r setup, include=FALSE, warning=F, message=F}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(MASS)
library(ggplot2)
library(viridis)
library(dplyr)
library(miceadds)
library(stringr)
library(gdata)
library(latex2exp)
library(tidyr)
library(ggpubr)
library(raster)
library("stats")
library(estimatr)
library(lmtest)
library(sandwich)
library(grid)
library(gridExtra)
library("matrixStats")
library(car)
library(plm)
library(stargazer)
library(magrittr)
library(texreg)
library(xtable)
library(tibble)
library(lme4)
library(nlme)

# read in all data files for sessions 1 through 8
for(i in 1:8) {
  x <- read_excel(paste("Cleaned_Raw_Session_0", i, ".xlsx", sep = "")) %>% dplyr::select(
    Session, Period, Subject, Player, partner, LType, Map_Selection = Map, EDG5:EW1, TE1:TE5, pEDG5:pEW1, Win1:Win5
  ) 
 nam <- paste("df", i, sep = "_")
 assign(nam, x)
}

# combine data vertically
df <- rbind(df_1, df_2, df_3, df_4, df_5, df_6, df_7, df_8)
# library(tidyr)
# long_df <- df %>% gather(District, Effort, EDG5:EW1)
df <- df %>% rename(Partner = partner,
  EDG_5 = EDG5, EDG_4 = EDG4, EDG_3 = EDG3, EDG_2 = EDG2, EDG_1 = EDG1,
  ELG_5 = ELG5, ELG_4 = ELG4, ELG_3 = ELG3, ELG_2 = ELG2, ELG_1 = ELG1,
  EW_5  = EW5, EW_4  = EW4, EW_3  = EW3, EW_2  = EW2, EW_1  = EW1,
  TE_5 = TE5, TE_4 = TE4, TE_3 = TE3, TE_2 = TE2, TE_1 = TE1,
  pEDG_5 = pEDG5, pEDG_4 = pEDG4, pEDG_3 = pEDG3, pEDG_2 = pEDG2, pEDG_1 = pEDG1,
  pELG_5 = pELG5, pELG_4 = pELG4, pELG_3 = pELG3, pELG_2 = pELG2, pELG_1 = pELG1,
  pEW_5  = pEW5, pEW_4  = pEW4, pEW_3  = pEW3, pEW_2  = pEW2, pEW_1  = pEW1
)
long_df <- df %>% dplyr::select(Session, Period, Subject, Player, Partner, LType, EDG_5:EW_1, pEDG_5:pEW_1) %>% gather(District, Effort, EDG_5:pEW_1)

# Orderly data with district, Map, and effort amount for each subject each period in each session

# No need to use long_df_map because already renamed them manually above
df_clean <- long_df %>% separate(District, c("District", "Map")) %>% filter(!grepl("p", District))

# get some interesting tables
avg.bid.map.district <- df_clean %>% group_by(Player, Map, District) %>% summarise(avg.Effort = mean(as.numeric(Effort)))
avg.bid.by.session <- df_clean %>% group_by(Session) %>% summarise(avg.Effort = mean(as.numeric(Effort)))
avg.bid.session.map.district <- df_clean %>% group_by(Session, Map, District) %>% summarise(avg.Effort = mean(as.numeric(Effort)))
# recall: periods 15 - 24 are Stage 1, 25-27 are Stage 2, and 28 is Stage 3
avg.bid.by.period <- df_clean %>% group_by(Period, Map, District) %>% summarise(avg.Effort = mean(as.numeric(Effort)))

# Let's consider just the competitive districts
df_comp <- df_clean %>% subset(District == "EW" | (District==c("EDG","ELG") & Map == 4))
avg.bid.comp.dist <- df_comp %>% group_by(Map, District) %>% summarise(avg.Effort = mean(as.numeric(Effort)))
avg.bid.comp.session <- df_comp %>% group_by(Session) %>% summarise(avg.Effort = mean(as.numeric(Effort)))
avg.bid.comp.session.map.dist <- df_comp %>% group_by(Session, Map, District) %>% summarise(avg.Effort = mean(as.numeric(Effort)))

##
theme_set(theme_pubr())
```

\newpage

Note that in Gerry_A, Gerry_B, Symm_1_1, and Symm_1_3 the white district is the only competitive district in the sense that only the competition within the white district determines whether a subject wins that Map. The exception is Symm_3_1 in which it is logical to bid in any district as no district is guaranteed a victor.

Gerry_B


```{r, message=F, echo=F}
# Equilibrium effort: .25v
g1.1 <- ggplot(df, aes(x = EDG_1)) + 
  stat_ecdf(geom = "step") + 
  geom_vline(xintercept = 0, linetype = "dashed") + xlim(0,80) +
  facet_wrap(~Player) + 
  ggtitle("Bids in Dark Grey: Gerry_B")
g1.2 <- ggplot(df, aes(x = ELG_1)) + 
  stat_ecdf(geom = "step") + 
  geom_vline(xintercept = 0, linetype = "dashed") + xlim(0,80) +
  facet_wrap(~Player) + 
  ggtitle("Bids in Light Grey: Gerry_B")
g1.3 <- ggplot(df, aes(x = EW_1)) + 
  stat_ecdf(geom = "step") + 
  geom_vline(xintercept = 20, linetype = "dashed") + xlim(0,80)+
  facet_wrap(~Player) + 
  ggtitle("Bids in White: Gerry_B")

figure <- ggarrange(g1.1, g1.2, g1.3,
                    labels = c("A", "B", "C"),
                    ncol = 2, nrow = 2)
figure
```

\newpage
  
$Symmetric_{1,1}$


```{r, message=F, echo=F}
# Equilibrium effort: .25v
g2.1 <- ggplot(df, aes(x = EDG_2)) + 
  stat_ecdf(geom = "step") + 
  geom_vline(xintercept = 0, linetype = "dashed") + xlim(0,80)+
  facet_wrap(~Player) + 
  ggtitle("Bids in Dark Grey: Symm_1_1")
g2.2 <- ggplot(df, aes(x = ELG_2)) + 
  stat_ecdf(geom = "step") + 
  geom_vline(xintercept = 0, linetype = "dashed") + xlim(0,80)+
  facet_wrap(~Player) + 
  ggtitle("Bids in Light Grey: Symm_1_1")
g2.3 <- ggplot(df, aes(x = EW_2)) + 
  stat_ecdf(geom = "step") + 
  geom_vline(xintercept = 20, linetype = "dashed") + xlim(0,80)+
  facet_wrap(~Player) + 
  ggtitle("Bids in White: Symm_1_1")

figure.2 <- ggarrange(g2.1, g2.2, g2.3,
                    labels = c("A", "B", "C"),
                    ncol = 2, nrow = 2)
figure.2
```

\newpage

$Symmetric_{1,3}$


```{r, message=F, echo=F}
# Equilibrium effort: 3/8 v
g3.1 <- ggplot(df, aes(x = EDG_3)) + 
  stat_ecdf(geom = "step") + 
  geom_vline(xintercept = 0, linetype = "dashed") + xlim(0,80)+
  facet_wrap(~Player) + 
  ggtitle("Bids in Dark Grey: Symm_1_3")
g3.2 <- ggplot(df, aes(x = ELG_3)) + 
  stat_ecdf(geom = "step") + 
  geom_vline(xintercept = 0, linetype = "dashed") + xlim(0,80)+
  facet_wrap(~Player) + 
  ggtitle("Bids in Light Grey: Symm_1_3")
g3.3 <- ggplot(df, aes(x = EW_3)) + 
  stat_ecdf(geom = "step") + 
  geom_vline(xintercept = 60, linetype = "dashed") + xlim(0,80)+
  facet_wrap(~Player) + 
  ggtitle("Bids in White: Symm_1_3")

figure.3 <- ggarrange(g3.1, g3.2, g3.3,
                    labels = c("A", "B", "C"),
                    ncol = 2, nrow = 2)
figure.3
```

\newpage

$Symmetric_{3,1}$


```{r, message=F, echo=F}
# Equilibrium effort: .125v per district
g4.1 <- ggplot(df, aes(x = EDG_4)) + 
  stat_ecdf(geom = "step") + 
  geom_vline(xintercept = 20, linetype = "dashed") + xlim(0,80)+
  facet_wrap(~Player) + 
  ggtitle("Bids in Dark Grey: Symm_3_1")
g4.2 <- ggplot(df, aes(x = ELG_4)) + 
  stat_ecdf(geom = "step") + 
  geom_vline(xintercept = 20, linetype = "dashed") + xlim(0,80)+
  facet_wrap(~Player) + 
  ggtitle("Bids in Light Grey: Symm_3_1")
g4.3 <- ggplot(df, aes(x = EW_4)) + 
  stat_ecdf(geom = "step") + 
  geom_vline(xintercept = 20, linetype = "dashed") + xlim(0,80)+
  facet_wrap(~Player) + 
  ggtitle("Bids in White: Symm_3_1")

figure.4 <- ggarrange(g4.1, g4.2, g4.3,
                    labels = c("A", "B", "C"),
                    ncol = 2, nrow = 2)
figure.4
```

\newpage

Gerry_A


```{r, message=F, echo=F}
# Equilibrium effort: .25v
g5.1 <- ggplot(df, aes(x = EDG_5)) + 
  stat_ecdf(geom = "step") + 
  geom_vline(xintercept = 0, linetype = "dashed") + xlim(0,80)+
  facet_wrap(~Player) + 
  ggtitle("Bids in Dark Grey: Gerry_A")
g5.2 <- ggplot(df, aes(x = ELG_5)) + 
  stat_ecdf(geom = "step") + 
  geom_vline(xintercept = 0, linetype = "dashed") + xlim(0,80)+
  facet_wrap(~Player) + 
  ggtitle("Bids in Light Grey: Gerry_A")
g5.3 <- ggplot(df, aes(x = EW_5)) + 
  stat_ecdf(geom = "step") + 
  geom_vline(xintercept = 20, linetype = "dashed") + xlim(0,80)+
  facet_wrap(~Player) + 
  ggtitle("Bids in White: Gerry_A")

figure.5 <- ggarrange(g5.1, g5.2, g5.3,
                    labels = c("A", "B", "C"),
                    ncol = 2, nrow = 2)
figure.5
```

\newpage

Recall, Player A should pick Gerry_A and Player B should pick Gerry_B if they are choosing the map that gives them the best chance of winning.

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
stage_2 <- df %>% subset(Period > 24 & Period < 28) %>% 
  dplyr::select(Session, Subject, Period, Player, Map_Selection) %>% 
  mutate(subject.id = Session*8-(8-Subject))

mode_df <- stage_2 %>% group_by(subject.id, Player) %>% 
  summarise(
            mode.map = ifelse(length(unique(Map_Selection)) == 3, Map_Selection[3],modal(Map_Selection, ties = 'random')),
            selection.tie = ifelse(length(unique(Map_Selection)) == 3,1,0))

mode_df.v1 <- mode_df %>%
  mutate(renamed.mode.map = ifelse((mode.map == 1 & Player == "B")|(mode.map==5 & Player == "A"), "Advantaged",
                                   ifelse(mode.map==2, "Symm_1_1",
                                          ifelse(mode.map==3, "Symm_1_3",
                                                 ifelse(mode.map==4,"Symm_3_1", "Disadvantaged")))))

# mode_df.v1 <- mode_df.v1 %>%
#   mutate(New.tex.name = ifelse(renamed.mode.map=="Symm_1_3", deparse(TeX('$Sym_{1,3}$')),
#                                ifelse(renamed.mode.map=="Symm_1_1", deparse(TeX('$Sym_{1,1}$')),
#                                       ifelse(renamed.mode.map=="Symm_3_1", deparse(TeX('$Sym_{3,1}$')),
#                                              ifelse(renamed.mode.map=="Advantaged", deparse(TeX('$Advantaged$')), deparse(TeX('$Disadvantaged$')))))))
combined.bar <- ggplot(mode_df.v1, aes(x=renamed.mode.map)) + 
  geom_bar(aes(y = (..count..)/sum(..count..)),width = 0.5, alpha = 0.5, position="identity", fill = "#666666") +
  labs(
    x = "",
    y = ""
  ) +
  scale_y_continuous(labels=scales::percent) +
  scale_x_discrete(labels=c('Symm_1_1'= parse(text = TeX('$Sym_{1,1}$')),
                            'Symm_1_3'= parse(text = TeX('$Sym_{1,3}$')),
                            'Symm_3_1'= parse(text = TeX('$Sym_{3,1}$')),
                            'Advantaged'= parse(text = TeX('$Advantaged$')),
                            'Disadvantaged'= parse(text = TeX('$Disadvantaged$'))))
combined.bar + theme(axis.text.x = element_text(size = 20), axis.text.y = element_text(size = 20))

map_mode_bar <- ggplot(mode_df.v1, aes(x=renamed.mode.map, fill = Player, color = Player)) + 
  geom_bar(width = 0.5, alpha = 0.5, position="identity")
map_mode_bar + ggtitle("Modal Map Selection in Stage 2")

# map_mode_hist <- ggplot(mode_df, aes(x=mode.map, fill = Player, color = Player)) + 
#   geom_histogram(alpha = 0.5, position="identity")
# map_mode_hist

# sum(mode_df$mode.map == 1 & mode_df$Player == "A")
# subset(mode_df)
```

\newpage

The first figure depicts the map choices during the final stage for all participants. The second figure is of interest because we might have spillover from the previous stage whereby participants choose the map they have been choosing without really paying attention to the implications...or they could just be flipping the coin that they are the "incumbent" after randomization occurs.

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
# Create "last_period" as an empty vector and extract period 28 from each sessions
last_period <- subset(df, Period=="28")

last_period$Map_Selection <- as.character(last_period$Map_Selection)
last_period$Bug <- ifelse(last_period$Player == last_period$LType, "No", "Yes")

last_period.v1 <- last_period %>%
  mutate(renamed.map.selection = ifelse(Map_Selection==1, "Gerry_B",
                                   ifelse(Map_Selection==2, "Symm_1_1",
                                          ifelse(Map_Selection==3, "Symm_1_3",
                                                 ifelse(Map_Selection==4, "Symm_3_1",
                                                        ifelse(Map_Selection == 5, "Gerry_A", "No Selection"))))))

# combined.bar <- ggplot(mode_df.v1, aes(x=renamed.mode.map)) + 
#   geom_bar(width = 0.5, alpha = 0.5, position="identity", fill = "#FF6666") +
#   geom_text(aes(label = ..count..), stat = "count", vjust = 1.5, colour = "black", size = 8) +
#   xlab("") + ylab("")
# combined.bar + theme(axis.text.x = element_text(size = 20), axis.text.y = element_text(size = 20))
# Adding filter here to remove the guy who left the session while choosing a 

stage3_map <- last_period.v1 %>% filter(renamed.map.selection != "No Selection") %>%
  ggplot(aes(x=renamed.map.selection)) +
  geom_bar(aes(y = (..count..)/sum(..count..)),width = 0.5, alpha = 0.5, position="identity", fill = "#666666") +
  #geom_text(aes(label = ..count..), stat = "count", vjust = 1.5, colour = "black", size = 8) +
  xlab("") + ylab("") +
  scale_y_continuous(labels=scales::percent) +
  scale_x_discrete(labels=c('Symm_1_1'= parse(text = TeX('$Sym_{1,1}$')),
                            'Symm_1_3'= parse(text = TeX('$Sym_{1,3}$')),
                            'Symm_3_1'= parse(text = TeX('$Sym_{3,1}$')),
                            'Gerry_A'= parse(text = TeX('$Gerry_A$')),
                            'Gerry_B'= parse(text = TeX('$Gerry_B$'))))
stage3_map + theme(axis.text.x = element_text(size = 20), axis.text.y = element_text(size = 20))


df.stage.3.selection <- last_period.v1 %>% filter(renamed.map.selection != "No Selection") %>%
  group_by(renamed.map.selection) %>% summarize(count = n()) %>% 
    mutate(Percent = count/sum(count))
ggplot(data = df.stage.3.selection, aes(x = renamed.map.selection, y = Percent, label = paste0(round(Percent,2),"%"), fill = "#FF6666")) + geom_bar(stat="identity", alpha = 0.5) + xlab("") + guides(fill = FALSE) + theme(axis.text.x = element_text(size = 20), axis.text.y = element_text(size = 20), axis.title.y = element_text(size = 20))

# Adding filter here to remove the guy who left the session while choosing a map
last_period.v1 %>% filter(renamed.map.selection != "No Selection") %>%
  ggplot(aes(x=renamed.map.selection, fill = Player, color = Player)) +
    stat_count(width = 0.5, alpha = 0.5, position="identity") +
  geom_text(aes(label = ..count..), stat = "count", vjust = 1.5, colour = "white")
```


\newpage

Now we are addressing:


1) For the map where they should be bidding on every region, I would like to see player A’s 3 CDFs overlaid on top of each other because there’s no reason for them to differ but it’s hard to tell in the version you sent. 

2) I would also like to see player B’s CDFs overlaid

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
df_clean <- df_clean %>% mutate(subject.id = as.numeric(Session)*8-(8-as.numeric(Subject)))
df_all_cdf <- df_clean %>% dplyr::select(Session, Period, subject.id, Player, District, Map, Effort) %>%
  filter(!grepl("p", District))

only.4 <- df_all_cdf %>% filter(Map == 4) # %>% group_by(subject.id, District, Effort)

ggplot(only.4, aes(x = as.numeric(Effort), size = "1")) + 
  stat_ecdf(aes(colour=District)) +
  geom_vline(xintercept = 10, linetype = "dashed") + xlim(0,80)+
  facet_wrap(~Player) +
  ggtitle("Symm_3_1") + guides(size = F)
```


3), 4), & 5) Separately I would like to overlay player A and B’s CDFs for districts 1-3 in the map where they bid on all districts since there’s no reason for these to differ. 

To do this, recall the map structures. The Dark Gray district of every map for Player A is symmetric to the Light Gray district of the same map for Player B. That is, the Dark Gray district in $Sym_{1,1}$ for Player A is symmetric to the Light Gray district in $Sym_{1,1}$ for Player B. With that in mind, consider the following CDFs where each compares the symmetric districts of Players A and B.

[DONE]- As a first pass, we should run a K-S tests to see if the various pairs of distributions you overlaid are the same.

```{r ks_tests_all_stage_1, echo=F, fig.height=5, fig.width=10, message=FALSE, warning=FALSE}
# To compare DG for A and LG for B we need to rename the districts to easily facet wrap them:
## STAGE 1 ONLY because that's how we compared district level expenditures
##
df_all_cdf <- df_all_cdf %>%
  filter(Period >= 15, Period <= 24) %>%
  mutate(District.compare = ifelse((District == "EDG" & Player == 'A')|(District == "ELG" & Player == 'B'), "DG Player A to LG Player B",
                                   ifelse((District == "ELG" & Player == 'A')|(District == "EDG" & Player == 'B'), "LG Player A to DG Player B","W for Both Players")),
          Advantage = ifelse((Player == "A" & Map == 5)|(Player == "B" & Map == 1), "Adv", 
                            ifelse((Player == "B" & Map == 5)|(Player == "A" & Map == 1),"Dis.adv", "fair")))

df_all_cdf <- df_all_cdf %>%
  mutate(Adv.District.Names = ifelse((Map == 1 & District == "EDG" & Player == "B")|(Map == 5 & District == "ELG" & Player == "A"), "Two Partisan For",
                                     ifelse((Map == 1 & District == "ELG" & Player == "B")|(Map == 5 & District == "EDG" & Player == "A"), "Three Partisan Against",
                                            ifelse((Map == 1 & District == "EW" & Player == "B")|(Map == 5 & District == "EW" & Player == "A"),"One Partisan For", "Error"))),
         Disadv.District.Names = ifelse((Map == 1 & District == "EDG" & Player == "A")|(Map == 5 & District == "ELG" & Player == "B"), "Two Partisan Against",
                                     ifelse((Map == 1 & District == "ELG" & Player == "A")|(Map == 5 & District == "EDG" & Player == "B"), "Three Partisan For",
                                            ifelse((Map == 1 & District == "EW" & Player == "A")|(Map == 5 & District == "EW" & Player == "B"),"One Partisan Against", "Error"))))
##

# Advantaged "One Partisan For"
ADV.A.one.partisan.for <- subset(df_all_cdf, Advantage == "Adv" & Player == "A" & Adv.District.Names == "One Partisan For")[,"Effort"]
ADV.B.one.partisan.for <- subset(df_all_cdf, Advantage == "Adv" & Player == "B" & Adv.District.Names == "One Partisan For")[,"Effort"]
ADV.one.partisan.for <- ks.test(as.numeric(unlist(ADV.A.one.partisan.for)),as.numeric(unlist(ADV.B.one.partisan.for)))
ADV.one.partisan.for_result <- ifelse(ADV.one.partisan.for[["p.value"]] < .05, "Reject the null", "Fail to reject the null")
#print(ADV.one.partisan.for_result)

# Advantaged "Two Partisan For"
ADV.A.two.partisan.for <- subset(df_all_cdf, Advantage == "Adv" & Player == "A" & Adv.District.Names == "Two Partisan For")[,"Effort"]
ADV.B.two.partisan.for <- subset(df_all_cdf, Advantage == "Adv" & Player == "B" & Adv.District.Names == "Two Partisan For")[,"Effort"]
ADV.two.partisan.for <- ks.test(as.numeric(unlist(ADV.A.two.partisan.for)),as.numeric(unlist(ADV.B.two.partisan.for)))
ADV.two.partisan.for_result <- ifelse(ADV.two.partisan.for[["p.value"]] < .05, "Reject the null", "Fail to reject the null")
#print(ADV.two.partisan.for_result)

# Advantaged "Three Partisan Against"
ADV.A.three.partisan.against <- subset(df_all_cdf, Advantage == "Adv" & Player == "A" & Adv.District.Names == "Three Partisan Against")[,"Effort"]
ADV.B.three.partisan.against <- subset(df_all_cdf, Advantage == "Adv" & Player == "B" & Adv.District.Names == "Three Partisan Against")[,"Effort"]
ADV.three.partisan.against <- ks.test(as.numeric(unlist(ADV.A.three.partisan.against)),as.numeric(unlist(ADV.B.three.partisan.against)))
ADV.three.partisan.against_result <- ifelse(ADV.three.partisan.against[["p.value"]] < .05, "Reject the null", "Fail to reject the null")
#print(ADV.three.partisan.against_result)

# Disadvantaged "One Partisan Against"
Dis.ADV.A.one.partisan.against <- subset(df_all_cdf, Advantage == "Dis.adv" & Player == "A" & Disadv.District.Names == "One Partisan Against")[,"Effort"]
Dis.ADV.B.one.partisan.against <- subset(df_all_cdf, Advantage == "Dis.adv" & Player == "B" & Disadv.District.Names == "One Partisan Against")[,"Effort"]
Dis.ADV.one.partisan.against <- ks.test(as.numeric(unlist(Dis.ADV.A.one.partisan.against)),as.numeric(unlist(Dis.ADV.B.one.partisan.against)))
Dis.ADV.one.partisan.against_result <- ifelse(Dis.ADV.one.partisan.against[["p.value"]] < .05, "Reject the null", "Fail to reject the null")
#print(Dis.ADV.one.partisan.against_result)

# Disadvantaged "Two Partisan Against"
Dis.ADV.A.two.partisan.against <- subset(df_all_cdf, Advantage == "Dis.adv" & Player == "A" & Disadv.District.Names == "Two Partisan Against")[,"Effort"]
Dis.ADV.B.two.partisan.against <- subset(df_all_cdf, Advantage == "Dis.adv" & Player == "B" & Disadv.District.Names == "Two Partisan Against")[,"Effort"]
Dis.ADV.two.partisan.against <- ks.test(as.numeric(unlist(Dis.ADV.A.two.partisan.against)),as.numeric(unlist(Dis.ADV.B.two.partisan.against)))
Dis.ADV.two.partisan.against_result <- ifelse(Dis.ADV.two.partisan.against[["p.value"]] < .05, "Reject the null", "Fail to reject the null")
#print(Dis.ADV.two.partisan.against_result)

# Disadvantaged "Three Partisan For"
Dis.ADV.A.three.partisan.for <- subset(df_all_cdf, Advantage == "Dis.adv" & Player == "A" & Disadv.District.Names == "Three Partisan For")[,"Effort"]
Dis.ADV.B.three.partisan.for <- subset(df_all_cdf, Advantage == "Dis.adv" & Player == "B" & Disadv.District.Names == "Three Partisan For")[,"Effort"]
Dis.ADV.three.partisan.for <- ks.test(as.numeric(unlist(Dis.ADV.A.three.partisan.for)),as.numeric(unlist(Dis.ADV.B.three.partisan.for)))
Dis.ADV.three.partisan.for_result <- ifelse(Dis.ADV.three.partisan.for[["p.value"]] < .05, "Reject the null", "Fail to reject the null")
#print(Dis.ADV.three.partisan.for_result)

ADV <- c(ADV.one.partisan.for[["p.value"]], ADV.two.partisan.for[["p.value"]], ADV.three.partisan.against[["p.value"]])
DisAdv <- c(Dis.ADV.one.partisan.against[["p.value"]], Dis.ADV.two.partisan.against[["p.value"]], Dis.ADV.three.partisan.for[["p.value"]])
Comparison <- c("One Partisan Voters", "Two Partisan Voters", "Three Partisan Voters")
adv.disadv.ks.tests <- data.frame(Comparison, ADV, DisAdv)
adv.disadv.ks.tests$ADV <- as.numeric(round(adv.disadv.ks.tests$ADV, 3))
adv.disadv.ks.tests$DisAdv <- as.numeric(round(adv.disadv.ks.tests$DisAdv, 3))


# Symmetric 1,1
EW2A <- subset(df_all_cdf, Map == 2 & District == "EW" & Player == "A")[,"Effort"]
EW2B <- subset(df_all_cdf, Map == 2 & District == "EW" & Player == "B")[,"Effort"]
EDG2A <- subset(df_all_cdf, Map == 2 & District == "EDG" & Player == "A")[,"Effort"]
EDG2B <- subset(df_all_cdf, Map == 2 & District == "EDG" & Player == "B")[,"Effort"]
ELG2A <- subset(df_all_cdf, Map == 2 & District == "ELG" & Player == "A")[,"Effort"]
ELG2B <- subset(df_all_cdf, Map == 2 & District == "ELG" & Player == "B")[,"Effort"]

EW2 <- ks.test(as.numeric(unlist(EW2A)),as.numeric(unlist(EW2B)))
DarkGrayA_to_LightGrayB_Sym_1_1 <- ks.test(as.numeric(unlist(EDG2A)),as.numeric(unlist(ELG2B)))
LightGrayA_to_DarkGrayB_Sym_1_1 <- ks.test(as.numeric(unlist(ELG2A)),as.numeric(unlist(EDG2B)))

EW2_result <- ifelse(EW2[["p.value"]] < .05, "Reject the null", "Fail to reject the null")
DarkGrayA_to_LightGrayB_Sym_1_1_result <- ifelse(DarkGrayA_to_LightGrayB_Sym_1_1[["p.value"]] < .05, "Reject the null", "Fail to reject the null")
LightGrayA_to_DarkGrayB_Sym_1_1_result <- ifelse(LightGrayA_to_DarkGrayB_Sym_1_1[["p.value"]] < .05, "Reject the null", "Fail to reject the null")

# Symmetric 1,3
EW3A <- subset(df_all_cdf, Map == 3 & District == "EW" & Player == "A")[,"Effort"]
EW3B <- subset(df_all_cdf, Map == 3 & District == "EW" & Player == "B")[,"Effort"]
EDG3A <- subset(df_all_cdf, Map == 3 & District == "EDG" & Player == "A")[,"Effort"]
EDG3B <- subset(df_all_cdf, Map == 3 & District == "EDG" & Player == "B")[,"Effort"]
ELG3A <- subset(df_all_cdf, Map == 3 & District == "ELG" & Player == "A")[,"Effort"]
ELG3B <- subset(df_all_cdf, Map == 3 & District == "ELG" & Player == "B")[,"Effort"]

EW3 <- ks.test(as.numeric(unlist(EW3A)),as.numeric(unlist(EW3B)))
DarkGrayA_to_LightGrayB_Sym_1_3 <- ks.test(as.numeric(unlist(EDG3A)),as.numeric(unlist(ELG3B)))
LightGrayA_to_DarkGrayB_Sym_1_3 <- ks.test(as.numeric(unlist(ELG3A)),as.numeric(unlist(EDG3B)))

EW3_result <- ifelse(EW3[["p.value"]] < .05, "Reject the null", "Fail to reject the null")
DarkGrayA_to_LightGrayB_Sym_1_3_result <- ifelse(DarkGrayA_to_LightGrayB_Sym_1_3[["p.value"]] < .05, "Reject the null", "Fail to reject the null")
LightGrayA_to_DarkGrayB_Sym_1_3_result <- ifelse(LightGrayA_to_DarkGrayB_Sym_1_3[["p.value"]] < .05, "Reject the null", "Fail to reject the null")

# Map 4 Dark Grey
EW4A <- subset(df_all_cdf, Map == 4 & District == "EW" & Player == "A")[,"Effort"]
EW4B <- subset(df_all_cdf, Map == 4 & District == "EW" & Player == "B")[,"Effort"]
EDG4A <- subset(df_all_cdf, Map == 4 & District == "EDG" & Player == "A")[,"Effort"]
EDG4B <- subset(df_all_cdf, Map == 4 & District == "EDG" & Player == "B")[,"Effort"]
ELG4A <- subset(df_all_cdf, Map == 4 & District == "ELG" & Player == "A")[,"Effort"]
ELG4B <- subset(df_all_cdf, Map == 4 & District == "ELG" & Player == "B")[,"Effort"]

EW4 <- ks.test(as.numeric(unlist(EW4A)),as.numeric(unlist(EW4B)))
DarkGrayA_to_LightGrayB_Sym_3_1 <- ks.test(as.numeric(unlist(EDG4A)),as.numeric(unlist(ELG4B)))
LightGrayA_to_DarkGrayB_Sym_3_1 <- ks.test(as.numeric(unlist(ELG4A)),as.numeric(unlist(EDG4B)))

EW4_result <- ifelse(EW4[["p.value"]] < .05, "Reject the null", "Fail to reject the null")
DarkGrayA_to_LightGrayB_Sym_3_1_result <- ifelse(DarkGrayA_to_LightGrayB_Sym_3_1[["p.value"]] < .05, "Reject the null", "Fail to reject the null")
LightGrayA_to_DarkGrayB_Sym_3_1_result <- ifelse(LightGrayA_to_DarkGrayB_Sym_3_1[["p.value"]] < .05, "Reject the null", "Fail to reject the null")

# p.value <- c(EW2[["p.value"]],ELG2[["p.value"]], EDG2[["p.value"]],
#        EW3[["p.value"]],ELG3[["p.value"]], EDG3[["p.value"]],
#        EW4[["p.value"]],ELG4[["p.value"]], EDG4[["p.value"]],
#        Dis.ADV.one.partisan.against[["p.value"]], Dis.ADV.two.partisan.against[["p.value"]], Dis.ADV.three.partisan.for[["p.value"]],
#        ADV.one.partisan.for[["p.value"]], ADV.two.partisan.for[["p.value"]], ADV.three.partisan.against[["p.value"]])
# 
# Action <- c(EW2_result,ELG2_result, EDG2_result,
#        EW3_result,ELG3_result, EDG3_result,
#        EW4_result,ELG4_result, EDG4_result,
#        Dis.ADV.one.partisan.against_result, Dis.ADV.two.partisan.against_result, Dis.ADV.three.partisan.for_result,
#        ADV.one.partisan.for_result, ADV.two.partisan.for_result, ADV.three.partisan.against_result)
# K.S.Test <- c("EW2_result","ELG2_result", "EDG2_result",
#        "EW3_result","ELG3_result", "EDG3_result",
#        "EW4_result","ELG4_result", "EDG4_result",
#        "Dis.ADV.one.partisan.against_result", "Dis.ADV.two.partisan.against_result", "Dis.ADV.three.partisan.for_result",
#        "ADV.one.partisan.for_result", "ADV.two.partisan.for_result", "ADV.three.partisan.against_result")
# k.s.test.results <- data.frame(K.S.Test, p.value, Action)

Sym.1.1 <- c(EW2[["p.value"]], DarkGrayA_to_LightGrayB_Sym_1_1[["p.value"]], LightGrayA_to_DarkGrayB_Sym_1_1[["p.value"]])
Sym.1.3 <- c(EW3[["p.value"]], DarkGrayA_to_LightGrayB_Sym_1_3[["p.value"]], LightGrayA_to_DarkGrayB_Sym_1_3[["p.value"]])
Sym.3.1 <- c(EW4[["p.value"]], DarkGrayA_to_LightGrayB_Sym_3_1[["p.value"]], LightGrayA_to_DarkGrayB_Sym_3_1[["p.value"]])
Comparison <- c("A White to B White", "A Dark Gray to B Light Gray", "A Light Gray to B Dark Gray")
sym.k.s.tests <- data.frame(Comparison, Sym.1.1, Sym.1.3, Sym.3.1)
sym.k.s.tests$Sym.1.1 <- round(sym.k.s.tests$Sym.1.1, 3)
sym.k.s.tests$Sym.1.1 <- as.numeric(sym.k.s.tests$Sym.1.1)
sym.k.s.tests$Sym.1.3 <- round(sym.k.s.tests$Sym.1.3, 3)
sym.k.s.tests$Sym.1.3 <- as.numeric(sym.k.s.tests$Sym.1.3)
sym.k.s.tests$Sym.3.1 <- round(sym.k.s.tests$Sym.3.1, 3)
sym.k.s.tests$Sym.3.1 <- as.numeric(sym.k.s.tests$Sym.3.1)
```


```{r cdf_checking_role, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
# To compare DG for A and LG for B we need to rename the districts to easily facet wrap them:
df_all_cdf <- df_all_cdf %>%
  filter(Period >= 15, Period <= 24) %>%
  mutate(District.compare = ifelse((District == "EDG" & Player == 'A')|(District == "ELG" & Player == 'B'), "DG Player A to LG Player B",
                                   ifelse((District == "ELG" & Player == 'A')|(District == "EDG" & Player == 'B'), "LG Player A to DG Player B","W for Both Players")),
          Advantage = ifelse((Player == "A" & Map == 5)|(Player == "B" & Map == 1), "Adv", 
                            ifelse((Player == "B" & Map == 5)|(Player == "A" & Map == 1),"Dis.adv", "fair")),
         Renamed.Map = ifelse((Map == 1 & Player == "B")|(Map == 5 & Player =="A"), "Advantaged",
                      ifelse((Map == 1 & Player == "A")|(Map == 5 & Player == "B"),"Disadvantaged",
                             ifelse(Map == 2, "Sym_1_1",
                                    ifelse(Map == 3, "Sym_1_3", "Sym_3_1")))))

dummy2 <- data.frame(District.compare = c("DG Player A to LG Player B","LG Player A to DG Player B","W for Both Players"), Z = c(0, 0, 20))

symm.1.1.cdf.all <- ggplot(df_all_cdf %>% 
         filter(Map == 2), aes(x = as.numeric(Effort))) +
  stat_ecdf(aes(colour=Player)) +
  scale_color_manual(values = c("Gray", "Black")) +
  facet_wrap(~District.compare)+
  geom_vline(data = dummy2, aes(xintercept = Z), linetype = "dashed") +
  xlim(0,80) + xlab("Expenditure") + ylab("Cumulative Probability") +
  #ggtitle(parse(text = TeX('$Sym_{1,1}$ by District'))) +
  guides(size = F)

label = c(sprintf("italic(%s) == %.4f", "KSpvalue", sym.k.s.tests[2,2]), sprintf("italic(%s) == %.4f", "KSpvalue", sym.k.s.tests[3,2]), sprintf("italic(%s) == %.4f", "KSpvalue", sym.k.s.tests[1,2]))
data_text <- data.frame(District.compare = c("DG Player A to LG Player B","LG Player A to DG Player B","W for Both Players"),
                        label,
                        x = c(60, 60, 60),
                        y = c(0.25, 0.25, 0.25),
                        stringsAsFactors = FALSE)
symm.1.1.cdf.all <- symm.1.1.cdf.all+                                                       # Add individual text to plot
  geom_text(data = data_text, mapping = aes(x = x,
                          y = y,
                          label = label), parse = TRUE)

dummy3 <- data.frame(District.compare = c("DG Player A to LG Player B","LG Player A to DG Player B","W for Both Players"), Z = c(0, 0, 30))
symm.1.3.cdf.all <- ggplot(df_all_cdf %>% 
         filter(Map == 3), aes(x = as.numeric(Effort))) +
  stat_ecdf(aes(colour=Player)) +
  scale_color_manual(values = c("Gray", "Black")) +
  facet_wrap(~District.compare)+
  geom_vline(data = dummy3, aes(xintercept = Z), linetype = "dashed") +
  xlim(0,80) + xlab("Expenditure") + ylab("Cumulative Probability") +
  #ggtitle(parse(text = TeX('$Sym_{1,3}$ by District'))) +
  guides(size = F)

label = c(sprintf("italic(%s) == %.4f", "KSpvalue", sym.k.s.tests[2,3]), sprintf("italic(%s) == %.4f", "KSpvalue", sym.k.s.tests[3,3]), sprintf("italic(%s) == %.4f", "KSpvalue", sym.k.s.tests[1,3]))
data_text <- data.frame(District.compare = c("DG Player A to LG Player B","LG Player A to DG Player B","W for Both Players"),
                        label,
                        x = c(60, 60, 60),
                        y = c(0.25, 0.25, 0.25),
                        stringsAsFactors = FALSE)
symm.1.3.cdf.all <- symm.1.3.cdf.all+                                                       # Add individual text to plot
  geom_text(data = data_text, mapping = aes(x = x,
                          y = y,
                          label = label), parse = TRUE)

dummy4 <- data.frame(District.compare = c("DG Player A to LG Player B","LG Player A to DG Player B","W for Both Players"), Z = c(10, 10, 10))
symm.3.1.cdf.all <- ggplot(df_all_cdf %>% 
         filter(Map == 4), aes(x = as.numeric(Effort))) +
  stat_ecdf(aes(colour=Player)) +
  scale_color_manual(values = c("Gray", "Black")) +
  facet_wrap(~District.compare)+
  geom_vline(data = dummy4, aes(xintercept = Z), linetype = "dashed") +
  xlim(0,80) + xlab("Expenditure") + ylab("Cumulative Probability") +
  #ggtitle(parse(text = TeX('$Sym_{3,1}$ by District'))) +
  guides(size = F)

label = c(sprintf("italic(%s) == %.4f", "KSpvalue", sym.k.s.tests[2,4]), sprintf("italic(%s) == %.4f", "KSpvalue", sym.k.s.tests[3,4]), sprintf("italic(%s) == %.4f", "KSpvalue", sym.k.s.tests[1,4]))
data_text <- data.frame(District.compare = c("DG Player A to LG Player B","LG Player A to DG Player B","W for Both Players"),
                        label,
                        x = c(60, 60, 60),
                        y = c(0.25, 0.25, 0.25),
                        stringsAsFactors = FALSE)
symm.3.1.cdf.all <- symm.3.1.cdf.all+                                                       # Add individual text to plot
  geom_text(data = data_text, mapping = aes(x = x,
                          y = y,
                          label = label), parse = TRUE)


# For Advantaged, compare Map 1, Player B white to Map 5, Player A white; Map 1, Player B DG to Map 5, Player A LG; Map 1, Player B LG to Map 5, Player A DG
dummy.adv <- data.frame(Adv.District.Names = c("Two Partisan For","Three Partisan Against","One Partisan For"), Z = c(0, 0, 20))
gerry_adv.cdf.all <- ggplot(df_all_cdf %>% 
         filter(Advantage == "Adv"), aes(x = as.numeric(Effort))) +
  stat_ecdf(aes(colour=Player)) +
  scale_color_manual(values = c("Gray", "Black")) +
  facet_wrap(~Adv.District.Names)+
  geom_vline(data = dummy.adv, aes(xintercept = Z), linetype = "dashed") +
  xlim(0,80) + xlab("Expenditure") + ylab("Cumulative Probability") +
  #ggtitle(parse(text = TeX('$Advantaged$'))) +
  guides(size = F)

label = c(sprintf("italic(%s) == %.4f", "KSpvalue", adv.disadv.ks.tests[1,2]), sprintf("italic(%s) == %.4f", "KSpvalue", adv.disadv.ks.tests[2,2]), sprintf("italic(%s) == %.4f", "KSpvalue", adv.disadv.ks.tests[3,2]))
data_text <- data.frame(Adv.District.Names = c("One Partisan For","Two Partisan For","Three Partisan Against"),
                        label,
                        x = c(60, 60, 60),
                        y = c(0.25, 0.25, 0.25),
                        stringsAsFactors = FALSE)

gerry_adv.cdf.all <- gerry_adv.cdf.all+                                                       # Add individual text to plot
  geom_text(data = data_text, mapping = aes(x = x,
                          y = y,
                          label = label), parse = TRUE)

dummy.disadv <- data.frame(Disadv.District.Names = c("Two Partisan Against","Three Partisan For","One Partisan Against"), Z = c(0, 0, 20))
gerry_disadv.cdf.all <- ggplot(df_all_cdf %>% 
         filter(Advantage == "Dis.adv"), aes(x = as.numeric(Effort))) +
  stat_ecdf(aes(colour=Player)) +
  scale_color_manual(values = c("Gray", "Black")) +
  facet_wrap(~Disadv.District.Names)+
  geom_vline(data = dummy.disadv, aes(xintercept = Z), linetype = "dashed") +
  xlim(0,80) + xlab("Expenditure") + ylab("Cumulative Probability") +
  #ggtitle(parse(text = TeX('$Disadvantaged$'))) +
  guides(size = F)
label = c(sprintf("italic(%s) == %.4f", "KSpvalue", adv.disadv.ks.tests[1,3]), sprintf("italic(%s) == %.4f", "KSpvalue", adv.disadv.ks.tests[2,3]), sprintf("italic(%s) == %.4f", "KSpvalue", adv.disadv.ks.tests[3,3]))
data_text <- data.frame(Disadv.District.Names = c("One Partisan Against","Two Partisan Against","Three Partisan For"),
                        label,
                        x = c(60, 60, 60),
                        y = c(0.25, 0.25, 0.25),
                        stringsAsFactors = FALSE)
gerry_disadv.cdf.all <- gerry_disadv.cdf.all+                                                       # Add individual text to plot
  geom_text(data = data_text, mapping = aes(x = x,
                          y = y,
                          label = label), parse = TRUE)

symm.1.1.cdf.all
symm.1.3.cdf.all
symm.3.1.cdf.all
gerry_adv.cdf.all
gerry_disadv.cdf.all
```

```{r table_of_regression_coefs_for_cdf, warning=F, message=F, echo=F, fig.width=10, fig.height=5}

Map <- c("Sym_1_1", "Sym_1_3", "Sym_3_1", "Advantaged", "Disadvantaged")
adv_coef_cdfs <- data.frame()
disadv_coef_cdfs <- data.frame()
fair_coef_cdfs <- data.frame()

adv_coef_cdfs.fixed.effects <- data.frame()
disadv_coef_cdfs.fixed.effects <- data.frame()
fair_coef_cdfs.fixed.effects <- data.frame()

adv_coef_cdfs.random.effects <- data.frame()
disadv_coef_cdfs.random.effects <- data.frame()
fair_coef_cdfs.random.effects <- data.frame()


for(c in Map){
  temp_df <- df_all_cdf %>% 
    filter(Renamed.Map == c) %>%
    mutate(Compare = ifelse(Renamed.Map == "Advantaged", Adv.District.Names,
                            ifelse(Renamed.Map == "Disadvantaged", Disadv.District.Names,
                  District.compare))) %>%
    dplyr::select(Renamed.Map,
           Compare,
           Effort,
           Player,
           subject.id
           )
  for(i in unique(temp_df$Compare)){
    temp_model <- lm(Effort ~ Player, temp_df %>% filter(Compare == i))
    temp_summary <- summary(temp_model)
    temp_intercept <- temp_summary[["coefficients"]][1,1]
    temp_intercept_pvalue <- temp_summary[["coefficients"]][1,4]
    temp_est <- temp_summary[["coefficients"]][2,1]
    temp_pvalue <- temp_summary[["coefficients"]][2,4]
    
    # # Fixed effects; no clustered standard error; probably better way to do this
    # temp_model.FE <- lm(Effort ~ Player + subject.id, temp_df %>% filter(Compare == i))
    # temp_summary.FE <- summary(temp_model.FE)
    # temp_intercept.FE <- temp_summary.FE[["coefficients"]][1,1]
    # temp_intercept_pvalue.FE <- temp_summary.FE[["coefficients"]][1,4]
    # temp_est.FE <- temp_summary.FE[["coefficients"]][2,1]
    # temp_pvalue.FE <- temp_summary.FE[["coefficients"]][2,4]
    # 
    
    dat <- df_all_cdf %>% mutate(Compare = ifelse(Renamed.Map == "Advantaged", Adv.District.Names,
                            ifelse(Renamed.Map == "Disadvantaged", Disadv.District.Names,
                  District.compare))) %>% filter(Renamed.Map == c, Compare == i)
    dat <- pdata.frame(dat, index=c("subject.id")  )
    # # Random effects; no clustered standard error; probably better way to do this
    temp_model.RE <- plm( Effort ~ Player , data= dat  , model="between")
    temp_summary.RE <- summary(temp_model.RE)
    temp_intercept.RE <- temp_summary.RE[["coefficients"]][1,1]
    temp_intercept_pvalue.RE <- temp_summary.RE[["coefficients"]][1,4]
    temp_est.RE <- temp_summary.RE[["coefficients"]][2,1]
    temp_pvalue.RE <- temp_summary.RE[["coefficients"]][2,4]
    
    if(c == "Advantaged"){
      adv_coef_cdfs[c,paste(i,"intercept",sep = " ")] <- temp_intercept
      adv_coef_cdfs[c,paste(i,"intercept p-value",sep = " ")] <- temp_intercept_pvalue
      adv_coef_cdfs[c,paste(i,"estimate",sep = " ")] <- temp_est
      adv_coef_cdfs[c,paste(i,"estimate p-value",sep = " ")] <- temp_pvalue
      
      # adv_coef_cdfs[c,paste(i,"intercept",sep = " ")] <- temp_intercept
      # adv_coef_cdfs[c,paste(i,"intercept p-value",sep = " ")] <- temp_intercept_pvalue
      # adv_coef_cdfs[c,paste(i,"estimate",sep = " ")] <- temp_est
      # adv_coef_cdfs[c,paste(i,"estimate p-value",sep = " ")] <- temp_pvalue
      # 
      adv_coef_cdfs.random.effects[c,paste(i,"intercept",sep = " ")] <- temp_intercept.RE
      adv_coef_cdfs.random.effects[c,paste(i,"intercept p-value",sep = " ")] <- temp_intercept_pvalue.RE
      adv_coef_cdfs.random.effects[c,paste(i,"estimate",sep = " ")] <- temp_est.RE
      adv_coef_cdfs.random.effects[c,paste(i,"estimate p-value",sep = " ")] <- temp_pvalue.RE
    }else if (c == "Disadvantaged"){
      disadv_coef_cdfs[c,paste(i,"intercept",sep = " ")] <- temp_intercept
      disadv_coef_cdfs[c,paste(i,"intercept p-value",sep = " ")] <- temp_intercept_pvalue
      disadv_coef_cdfs[c,paste(i,"estimate",sep = " ")] <- temp_est
      disadv_coef_cdfs[c,paste(i,"estimate p-value",sep = " ")] <- temp_pvalue
      
      # disadv_coef_cdfs[c,paste(i,"intercept",sep = " ")] <- temp_intercept
      # disadv_coef_cdfs[c,paste(i,"intercept p-value",sep = " ")] <- temp_intercept_pvalue
      # disadv_coef_cdfs[c,paste(i,"estimate",sep = " ")] <- temp_est
      # disadv_coef_cdfs[c,paste(i,"estimate p-value",sep = " ")] <- temp_pvalue
      # 
      disadv_coef_cdfs.random.effects[c,paste(i,"intercept",sep = " ")] <- temp_intercept.RE
      disadv_coef_cdfs.random.effects[c,paste(i,"intercept p-value",sep = " ")] <- temp_intercept_pvalue.RE
      disadv_coef_cdfs.random.effects[c,paste(i,"estimate",sep = " ")] <- temp_est.RE
      disadv_coef_cdfs.random.effects[c,paste(i,"estimate p-value",sep = " ")] <- temp_pvalue.RE
    }else{
      fair_coef_cdfs[c,paste(i,"intercept",sep = " ")] <- temp_intercept
      fair_coef_cdfs[c,paste(i,"intercept p-value",sep = " ")] <- temp_intercept_pvalue
      fair_coef_cdfs[c,paste(i,"estimate",sep = " ")] <- temp_est
      fair_coef_cdfs[c,paste(i,"estimate p-value",sep = " ")] <- temp_pvalue
      
      # fair_coef_cdfs[c,paste(i,"intercept",sep = " ")] <- temp_intercept
      # fair_coef_cdfs[c,paste(i,"intercept p-value",sep = " ")] <- temp_intercept_pvalue
      # fair_coef_cdfs[c,paste(i,"estimate",sep = " ")] <- temp_est
      # fair_coef_cdfs[c,paste(i,"estimate p-value",sep = " ")] <- temp_pvalue
      # 
      fair_coef_cdfs.random.effects[c,paste(i,"intercept",sep = " ")] <- temp_intercept.RE
      fair_coef_cdfs.random.effects[c,paste(i,"intercept p-value",sep = " ")] <- temp_intercept_pvalue.RE
      fair_coef_cdfs.random.effects[c,paste(i,"estimate",sep = " ")] <- temp_est.RE
      fair_coef_cdfs.random.effects[c,paste(i,"estimate p-value",sep = " ")] <- temp_pvalue.RE
      
    }
  }
}

xtable(adv_coef_cdfs)
# xtable(disadv_coef_cdfs)
# xtable(fair_coef_cdfs)

xtable(adv_coef_cdfs.random.effects)
xtable(disadv_coef_cdfs.random.effects)
xtable(fair_coef_cdfs.random.effects)

# ## Trying to figure out why I am getting different estimates for Player B effect when using different FE methods in R
dat <- df_all_cdf %>% mutate(Compare = ifelse(Renamed.Map == "Advantaged", Adv.District.Names,
                            ifelse(Renamed.Map == "Disadvantaged", Disadv.District.Names,
                  District.compare))) %>% filter(Renamed.Map == "Sym_3_1", Compare == "LG Player A to DG Player B")
# #dat <- dat %>% mutate(numberplayer = ifelse(Player == "B", 1, 0))
# m1 <- lm(Effort ~ Player, data = dat)
# m2 <- lmer(Effort ~ Player + (1 | subject.id), data = dat)
# 
# # I think using plm here is problematic because the player role does not vary by each subject.id, so perfect collinearity is the result and not providing a good plm index.
# # m2 <- plm(Effort ~ Player, data = dat, index = c("subject.id","Period"), model = "within")
# # m3 <- plm(Effort ~ Player, data = dat, index = "Period", model = "random")
z2 <- pdata.frame(dat, index=c("subject.id")  )    
m3 <- plm( Effort ~ Player , data= z2  , model="between") # matches xtreg , fe
# m4 <- lme(Effort ~ Player, data = dat, random = pdDiag(~subject.id))
# 
# 
# 
# summary(m1)
# summary(m2)
summary(m3)
# summary(m4)
```


```{r Regression_checking_role, warning=F, message=F, echo=F, fig.width=10, fig.height=5, eval=F}
# Regression of a constant, a dummy for the B role, subject fixed effects and clustered standard errors using data that generated cdfs above
df_all_cdf$subject.id <- as.factor(df_all_cdf$subject.id)
player.role.regression.data <- df_all_cdf %>% 
  mutate(PlayerB_Dummy = ifelse(Player == "A", 0, 1)) # this should have 13,440 observations

# The first and third regressions yield similar results, but the SE for the second regression is vastly different with much higher SEs
# This is something I do not understand and would like to ask someone about
player.role.check.with.FE.CSE <- lm.cluster(Effort ~ PlayerB_Dummy + subject.id, cluster = "Session", data = player.role.regression.data)
summary(player.role.check.with.FE.CSE)

temp <- lm(Effort ~ PlayerB_Dummy + subject.id, data = player.role.regression.data)
summary(temp)
temp.coef <- coeftest(temp, vcov=vcovHC(temp, cluster="Session"))
temp.coef

# Will have to CHANGE SE and p-value to reflect CSE
stargazer(temp,
          title = "Player Role Impact with Fixed Effects and Clustered Standard Errors",
          label = "Tab:player_role_impact_FE_CSE",
          omit = "subject.id", single.row = T)

m3fe <- lm_robust(Effort ~ Player,
                  clusters = Session,
                  #fixed_effects = ~subject.id,
                  data = player.role.regression.data)
summary(m3fe)

texreg(m3fe, include.ci = FALSE) 
```

\newpage


6) & 7) On each of the two maps where the players are symmetric and only bidding on one district I would like to see their CDF‘s overlaid. 

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
df_map_2 <- df_clean %>% 
  filter(Map == 2) %>% 
  dplyr::select(Period, subject.id, Player, Map, District, Effort)

df_map_3 <- df_clean %>% 
  filter(Map == 3) %>% 
  dplyr::select(Period, subject.id, Player, Map, District, Effort)

par(mfrow = c(1, 2))
# Bidding in Map 2 White District
symm.1.1.cdf <- ggplot(df_map_2 %>% filter(District == "EW"), aes(x=as.numeric(Effort), size = "1")) + 
  stat_ecdf(aes(colour=Player)) + 
  geom_vline(xintercept = 20, linetype = "dashed") + xlim(0,80)+
  #ggtitle("Symm_1_1: White District") + 
  guides(size = F)
symm.1.1.cdf
# Bidding in Map 3 White District
symm.1.3.cdf <- ggplot(df_map_3 %>% filter(District == "EW"), aes(x=as.numeric(Effort), size = "1")) + 
  stat_ecdf(aes(colour=Player)) + 
  geom_vline(xintercept = 30, linetype = "dashed") + xlim(0,80)+
  #ggtitle("Symm_1_3: White District") + 
  guides(size = F)
symm.1.3.cdf
```

\newpage

8) Overlay the CDFs of the advantage player in Gerry_B and the advantage player in Gerry_A.

9) Overlay the CDFs of the disadvantaged player in Gerry_B and the disadvantaged player in Gerry_A. 

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
dissag.df.overlay <- df_clean %>% 
  filter((Map == 1 | Map == 5) & District == "EW") %>% 
  dplyr::select(Period, subject.id, Player, Map, District, Effort) %>% 
  mutate(Advantage = ifelse((Player == "A" & Map == 5)|(Player == "B" & Map == 1), "Adv", "Dis.adv"))

par(mfrow = c(1, 2))

ggplot(dissag.df.overlay %>% filter(Advantage == "Adv"), aes(x=as.numeric(Effort), size = "1")) + 
  stat_ecdf(aes(colour=Player)) + 
  #ggtitle("Advantage Comparrison: White District") + 
  xlim(0,80)+
  geom_vline(xintercept = 20, linetype = "dashed") +
  guides(size = F)

ggplot(dissag.df.overlay %>% filter(Advantage == "Dis.adv"), aes(x=as.numeric(Effort), size = "1")) + 
  stat_ecdf(aes(colour=Player)) + 
  #ggtitle("Disadvantage Comparrison: White District") + 
  xlim(0,80)+
  geom_vline(xintercept = 20, linetype = "dashed") +
  guides(size = F)
```

\newpage

10) Assuming the two CDFs in 8) look the same and the two CDFs in 9) look the same, then make a combined advantaged CDF and a combined disadvantaged CDF and overlay those so we me can easily see how being advantaged matters.  


```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
adv.vs.disadv.cdf <- dissag.df.overlay %>%
  filter(Period <= 24) %>%
  ggplot(aes(x=as.numeric(Effort))) +
  scale_color_manual(values = c("black","green"), labels = c("Advantaged", "Disadvantaged")) +
  stat_ecdf(aes(colour=Advantage)) +
  geom_vline(xintercept = 20, linetype = "dashed") + xlim(0,80)+
  guides(size = F)

# use dimensions Width = and Height = 
adv.vs.disadv.cdf + 
  theme(legend.title = element_blank()) +
  xlab("Expenditure in White District") +
  ylab("Cumulative Percentage") +
  annotate('text', x=10, y=0.75, label = "Theoretical Prediction")

# Adv vs Dis.adv
ADV.All <- subset(dissag.df.overlay, Advantage == "Adv")[,"Effort"]
Dis.ADV.All <- subset(dissag.df.overlay, Advantage == "Dis.adv")[,"Effort"]

ks.test(as.numeric(unlist(ADV.All)),as.numeric(unlist(Dis.ADV.All)))
```

I'd like to know the average bid of advantaged players and the average bid of disadvantaged players.

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
dissag.df.overlay <- dissag.df.overlay %>%
  mutate(adv = ifelse(Advantage == "Adv",1,0),
         dis = ifelse(Advantage == "Dis.adv",1,0))

dissag.df.overlay %>% filter(adv==1) %>% summarise(mean(Effort))
dissag.df.overlay %>% filter(adv==0) %>% summarise(mean(Effort))

```
These average bids by advantaged and disadvantaged players seem odd given the difference in CDFs and the regression results below. How can we reconcile this discrepancy..?

Now let's throw together a large figure of all cdfs:
```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
symm.1.1.cdf <- symm.1.1.cdf + xlab("Bid")
symm.1.3.cdf <- symm.1.3.cdf + xlab("Bid")
symm.3.1.cdf.all <- symm.3.1.cdf.all + xlab("Bid")
adv.vs.disadv.cdf <- adv.vs.disadv.cdf + xlab("Bid")
# grid.arrange(symm.1.1.cdf, symm.1.3.cdf, symm.3.1.cdf.all, adv.vs.disadv.cdf, ncol = 2)
```


*************

To be added as of 2021-04-07

[DONE]- One other small improvement to all the CDF figures would be to add a vertical line at the theoretical prediction for that map. 

[DONE]- It looks like on Symm_3_1 there is a fair amount of zero bids placed on each map. My guess is that we have lots of instances where people bid on ONLY TWO MAPS. Could you find the proportions of cases (bid tripled by a person in a period) in Symm_3_1 where the person bid 0 on all three districts (that is in a period bid 0,0,0), bid 0 on one district (so 0,x,y or x,0,y, or x,y,0 for x,y>0), bid 0 on two districts, and bid 0 on none of the districts?  My guess is that there are lots of cases where they bid 0 on one map.

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
map_four_bidding <- df %>% dplyr::select(Session, Period, Subject, Player, EDG_4, ELG_4, EW_4)

map_four_bidding <- map_four_bidding %>% mutate(two.bids = ifelse((EDG_4 > 0 & ELG_4 > 0 & EW_4 == 0)|(EDG_4 > 0 & ELG_4 == 0 & EW_4 > 0)|(EDG_4 == 0 & ELG_4 > 0 & EW_4 > 0),1,0))

map_four_bidding <- map_four_bidding %>% mutate(one.bids = ifelse((EDG_4 > 0 & ELG_4 == 0 & EW_4 == 0)|(EDG_4 == 0 & ELG_4 > 0 & EW_4 == 0)|(EDG_4 == 0 & ELG_4 == 0 & EW_4 > 0),1,0))

map_four_bidding <- map_four_bidding %>% mutate(all.three.bids = ifelse((EDG_4 > 0 & ELG_4 > 0 & EW_4 > 0),1,0))

map_four_bidding <- map_four_bidding %>% mutate(all.zeros.bids = ifelse((EDG_4 == 0 & ELG_4 == 0 & EW_4 == 0),1,0))

summarize(map_four_bidding, n.records = n(),
          n.all.zeros = sum(all.zeros.bids),
          n.one.district  = sum(one.bids),
          n.two.districts = sum(two.bids),
          n.three.districts = sum(all.three.bids),
          pct.zeros = n.all.zeros/n.records,
          pct.bid.one = n.one.district/n.records,
          pct.bid.two = n.two.districts/n.records,
          pct.bid.three = n.three.districts/n.records,
          )

```

*************

[DONE]- Look at "spread" of own bids across Symm_3_1 (max bid in any district of Symm_3_1 - min bid in any district in Symm_3_1); we'd like to see this overall (graph?) and just in the cases they bid a positive amount on everything then, for the case they only bid on 2, look at the max minus the median

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
## Took way too long to figure this out (~2 hours)
# install.packages("matrixStats")
map_four_bidding <- map_four_bidding %>%
  mutate(districts.bid = ifelse(all.three.bids == 1, "Three", ifelse(two.bids == 1, "Two", ifelse(one.bids == 1, "One", "Zero"))),
         max_bid = pmax(EDG_4, ELG_4, EW_4),
         min_bid = pmin(EDG_4, ELG_4, EW_4),
         median_bid = rowMedians(as.matrix(map_four_bidding[,c(5,6,7)]))) # getting spread with "middle"
                                                                          # value

map_four_bidding <- map_four_bidding %>%
  mutate(Spread = ifelse(all.three.bids == 1, max_bid - min_bid, 
                         ifelse(two.bids == 1, max_bid - median_bid, 
                                ifelse(one.bids == 1, max_bid - min_bid, -1))))

map_four_bidding$districts.bid <- factor(map_four_bidding$districts.bid,                 # Re-level group factor
                         levels = c("Zero", "One", "Two", "Three"))

ggplot(map_four_bidding, aes(x=Spread, fill = districts.bid, color = districts.bid)) +
    stat_count(width = 0.5, alpha = 0.5, position="identity") + xlim(-2,80) +
  labs(title = "Unadjusted Spread",
                             subtitle = "Symm_3_1")


```

Separate graphs for bidding in two and separate for bidding in three (maybe under table with pct of Zero, One, Two, and Three bids in Symmetric_Map_3,1)

```{r scatter.plot.of.relative.district.level.expenditure.in.sym.3.1, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
spread.map.four <- map_four_bidding %>% filter(districts.bid == c("Two","Three")) %>%
  ggplot(aes(x=Spread, fill = districts.bid, color = districts.bid)) +
    stat_count(width = 0.5, alpha = 0.5, position="identity") + xlim(-2,80)+ 
  facet_wrap(~districts.bid) +
  labs(y = "Count", fill = "Districts with positive bids", color = "Districts with positive bids")
spread.map.four

# Requested 01/07/2022: 
# For Sym31, can you produce the following scatter plot where a person in a period is the observation.  So I think we should have 640 points.  The y coordinate equals (max expenditure on W,L,G) / (total expenditure on W,L,G) and the x coordinate equals (median expenditure on W,L,G) / (total expenditure on W,L,G).  Please add the line y=1-x for x between 0 and .5 and add a forty five degree line between (0,0) and (.5,.5). This is a candidate to replace the spread figure.  The individual dots should be small and we may need to jitter if there is a lot of overlap. 
scatter.spread <- map_four_bidding %>%
  filter(Period <= 24) %>%
  mutate(subject.id = Session*8-(8-Subject),
         total.bid  = (EDG_4 + ELG_4 + EW_4),
         max.over.total = max_bid/total.bid,
         med.over.total = median_bid/total.bid,
         ) %>%
  ggplot(aes(x = med.over.total, y = max.over.total))
scatter.spread + 
  # geom_count(aes(color = ..n..)) +
  geom_point() +
  labs(x = "Median District Expenditure Relative to Total Expenditure", 
       y = " Maximum District Expenditure Relative to Total Expenditure") +
  scale_color_gradient(low="blue", high="red") +
  xlim(0,0.75) +
  ylim(0,1) +
  geom_abline(intercept = 0, slope = 1) +
  geom_jitter(width = 0.025, height = 0.025) +
  coord_fixed()
```

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
## Do the pcts and the graphs treating bids =< 5 as if they are 0
# Adjusted Spread (all bids < 5 setting equal to 0)
adjusted_map_four_bidding <- df %>% dplyr::select(Session, Period, Subject, Player, EDG_4, ELG_4, EW_4)

# Replace bids <= 5 with 0
adjusted_map_four_bidding[,5:7][adjusted_map_four_bidding[,5:7] <= 5 ] <- 0

adjusted_map_four_bidding <- adjusted_map_four_bidding %>% mutate(two.bids = ifelse((EDG_4 > 0 & ELG_4 > 0 & EW_4 == 0)|(EDG_4 > 0 & ELG_4 == 0 & EW_4 > 0)|(EDG_4 == 0 & ELG_4 > 0 & EW_4 > 0),1,0))

adjusted_map_four_bidding <- adjusted_map_four_bidding %>% mutate(one.bids = ifelse((EDG_4 > 0 & ELG_4 == 0 & EW_4 == 0)|(EDG_4 == 0 & ELG_4 > 0 & EW_4 == 0)|(EDG_4 == 0 & ELG_4 == 0 & EW_4 > 0),1,0))

adjusted_map_four_bidding <- adjusted_map_four_bidding %>% mutate(all.three.bids = ifelse((EDG_4 > 0 & ELG_4 > 0 & EW_4 > 0),1,0))

adjusted_map_four_bidding <- adjusted_map_four_bidding %>% mutate(all.zeros.bids = ifelse((EDG_4 == 0 & ELG_4 == 0 & EW_4 == 0),1,0))

summarize(adjusted_map_four_bidding, n.records = n(),
          n.all.zeros = sum(all.zeros.bids),
          n.one.district  = sum(one.bids),
          n.two.districts = sum(two.bids),
          n.three.districts = sum(all.three.bids),
          pct.zeros = round((n.all.zeros/n.records)*100,1),
          pct.bid.one = round((n.one.district/n.records)*100,1),
          pct.bid.two = round((n.two.districts/n.records)*100,1),
          pct.bid.three = round((n.three.districts/n.records)*100,1),
          )

adjusted_map_four_bidding <- adjusted_map_four_bidding %>%
  mutate(districts.bid = ifelse(all.three.bids == 1, "Three", ifelse(two.bids == 1, "Two", ifelse(one.bids == 1, "One", "Zero"))),
         max_bid = pmax(EDG_4, ELG_4, EW_4),
         min_bid = pmin(EDG_4, ELG_4, EW_4),
         median_bid = rowMedians(as.matrix(adjusted_map_four_bidding[,c(5,6,7)])))

adjusted_map_four_bidding <- adjusted_map_four_bidding %>%
  mutate(Spread = ifelse(all.three.bids == 1, max_bid - min_bid, 
                         ifelse(two.bids == 1, max_bid - median_bid, 
                                ifelse(one.bids == 1, max_bid - min_bid, -1))))

adjusted_map_four_bidding$districts.bid <- factor(adjusted_map_four_bidding$districts.bid,         # Re-level group factor
                         levels = c("Zero", "One", "Two", "Three"))

ggplot(adjusted_map_four_bidding, aes(x=Spread, fill = districts.bid, color = districts.bid)) +
    stat_count(width = 0.5, alpha = 0.5, position="identity") + xlim(-2,80)+ 
  labs(title = "Adjusted Spread",
                             subtitle = "Symm_3_1")

adj.spread.4 <- adjusted_map_four_bidding %>% filter(districts.bid == c("Two","Three")) %>%
  ggplot(aes(x=Spread, fill = districts.bid, color = districts.bid)) +
    stat_count(width = 0.5, alpha = 0.5, position="identity") + xlim(-2,60)+ 
  facet_wrap(~districts.bid) + scale_fill_discrete(name = "Number of Districts with Bid > 5") + scale_color_discrete(name = "Number of Districts with Bid > 5")
adj.spread.4
```



[DONE]- Also, since it seems that things are symmetric, it would be good to make a single graph that has the cdfs of total pair level investment by map (here a pair in a period is an observation). That way we can see if more is spent on some maps than others.

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
# make each pair total an observation
# gotta pull in the pEDG, pELG, pEW metrics
# total effort by pair addition to data frame
df_pair_totals <- df %>% mutate(Pair_5 = EDG_5 + pEDG_5 + ELG_5 + pELG_5 + EW_5 + pEW_5,
                                   Pair_4 = EDG_4 + pEDG_4 + ELG_4 + pELG_4 + EW_4 + pEW_4,
                                   Pair_3 = EDG_3 + pEDG_3 + ELG_3 + pELG_3 + EW_3 + pEW_3,
                                   Pair_2 = EDG_2 + pEDG_2 + ELG_2 + pELG_2 + EW_2 + pEW_2,
                                  Pair_1 = EDG_1 + pEDG_1 + ELG_1 + pELG_1 + EW_1 + pEW_1)

df_pair_totals <- df_pair_totals %>% mutate(Partner_Player = 
                                                    ifelse(Player == "B","A","B"))

long_pairs_df <- df_pair_totals %>% 
  dplyr::select(Session, Period, Subject, Player, Partner, Partner_Player, LType, Pair_5:Pair_1) %>%
  gather(District, Pair_Effort, Pair_5:Pair_1)

cleaned_pairs <- long_pairs_df %>% separate(District, c("Pairs", "Map"))
cleaned_pairs <- cleaned_pairs %>%
  mutate(renamed.map = ifelse(Map==1, "Gerry_B",
                                   ifelse(Map==2, "Symm_1_1",
                                          ifelse(Map==3, "Symm_1_3",
                                                 ifelse(Map==4, "Symm_3_1", "Gerry_A")))))

## only look at subject == c(1,2,3,4) since we'd repeat the other metrics
ggplot(cleaned_pairs %>%
         filter(Subject == c(1,2,3,4)), aes(x = as.numeric(Pair_Effort), size = "1")) +
  stat_ecdf(aes(colour = renamed.map)) + 
  xlim(0,80) +
  ggtitle("Pair Total Bidding by Map") +
  guides(size = F)
```


[DONE]- One thing that would be good to do is for each kind of choice (advantaged in map 1 or 5, disadvantaged in map 1 or 5, white in map 2, white in map 3, all regions in map 4) take the average across all subjects in a period. Then plot a time series of those averages.  This should include phase 1 and 2 so we can see if map selection impacted bidding on maps.

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
time_series_avg <- df_clean %>% 
  filter(((Map == 1 | Map == 5 | Map == 2 | Map == 3) & District == "EW")|(Map == 4)) %>% 
  dplyr::select(Session, Period, subject.id, Player, Map, District, Effort) %>% 
  mutate(Advantage = ifelse((Player == "A" & Map == 5)|(Player == "B" & Map == 1), "Adv", 
                            ifelse((Player == "B" & Map == 5)|(Player == "A" & Map == 1),"Dis.adv", "fair")),
         Choice = ifelse(Advantage == "Adv", "Adv", 
                         ifelse(Advantage == "Dis.adv", "Dis", 
                                ifelse(Map == 3, "Symm_1_3 White", 
                                       ifelse(Map == 2, "Symm_1_1 White",
                                              ifelse(Map == 4 & District == "EW", "Symm_3_1 EW",
                                                     ifelse(Map == 4 & District == "EDG", "Symm_3_1 EDG", "Symm_3_1 ELG")))))))

# Get averages for advantages in map 1 or 5, disadvantaged in map 1 or 5, white in map 2 or 3, and all districts in map 4
session.level.ts.avgs <- time_series_avg %>% filter(Period < 28, District == c("EW","EDG","ELG")) %>% 
  group_by(Session, Period, Choice) %>% summarise(avg.Effort = mean(as.numeric(Effort)))


## These time series plots are only efforts of the competitive districts. We should also look at non competitive districts to determine if a learning effect is evident.
session.level.ts.avgs %>%
  ggplot(aes(x=Period, y=avg.Effort)) +
  geom_line(aes(color = as.character(Session))) + facet_wrap(~Choice) + xlim(15,27) + ylim(0,60) +
    scale_x_continuous(breaks=c(15:27)) +
  labs(color = "Session") + ylab("Average Bid")
```

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
# I want to compare average bids to those of existing literature for each of the relevant competitions
# That is: (1) Symm_1_1 = standard tullock with two players
#          (2) Symm_1_3 = must win 2/3 but bid same effort for each contest
#          (3) Symm_3_1 = must win 2/3 but able to bid different amounts
#          (4) Gerry    = win with unequal probabilities of winning (informational asymmetries??)

session.level.ts.avgs %>% 
  group_by(Choice) %>%
  summarise(avg.bid.in.map = mean(avg.Effort))
```


What about a time series plot with the average across all sessions?

```{r average.expenditure.by.district.in.stage.1, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
# The following big commented section is not right, but also not included in paper:

# time_series_avg_across_sessions <- df_clean %>% 
#   filter(((Map == 1 | Map == 5 | Map == 2 | Map == 3) & District == "EW")|(Map == 4)) %>% 
#   dplyr::select(Session, Period, subject.id, Player, Map, District, Effort) %>% 
#   mutate(Advantage = ifelse((Player == "A" & Map == 5)|(Player == "B" & Map == 1), "Adv", 
#                             ifelse((Player == "B" & Map == 5)|(Player == "A" & Map == 1),"Dis.adv", "fair")),
#          Choice = ifelse(Advantage == "Adv", "Gerrymander_Adv", 
#                          ifelse(Advantage == "Dis.adv", "Gerrymander_Dis", 
#                                 ifelse(Map == 3, "Symm_1_3 w", 
#                                        ifelse(Map == 2, "Symm_1_1 w",
#                                               ifelse(Map == 4 & District == "EW", "Symm_3_1 w",
#                                                      ifelse(Map == 4 & District == "EDG", "Symm_3_1 dg", "Symm_3_1 lg")))))))
# 
# # Get averages for advantages in map 1 or 5, disadvantaged in map 1 or 5, white in map 2 or 3, and all districts in map 4
# session.level.ts.avgs.across.sessions <- time_series_avg_across_sessions %>% 
#   filter(Period < 28, District == c("EW","EDG","ELG")) %>% 
#   group_by(Period, Choice) %>% 
#   summarise(avg.Effort = mean(as.numeric(Effort)))
# 
# session.level.ts.avgs.across.sessions$Period <- session.level.ts.avgs.across.sessions$Period - 14
# 
# 
# ## These time series plots are only efforts of the competitive districts. We should also look at non competitive districts to determine if a learning effect is evident.
# ts.plot.whole.study <- session.level.ts.avgs.across.sessions %>%
#   filter(Period < 11) %>%
#   ggplot(aes(x=Period, y=avg.Effort, color = Choice)) +
#   geom_line() + xlim(1,10) + ylim(0,60) +
#   scale_x_continuous(breaks=c(1:10)) +
#   labs(color = "Map and/or District", y = "Average Bid")
# ts.plot.whole.study



ts.each.map.each.dist <- df_clean %>% 
  dplyr::select(Session, Period, subject.id, Player, Map, District, Effort) %>% 
  mutate(Advantage = ifelse((Player == "A" & Map == 5)|(Player == "B" & Map == 1), "Adv", 
                            ifelse((Player == "B" & Map == 5)|(Player == "A" & Map == 1),"Dis.adv", "fair")))

# Light grey line for Light Gray district, Dark grey line for Dark gray district, dashed line for white district
# (we could make background different color to use a white line, but that'd look bad in black and white print)
ts.each.map.each.dist <- ts.each.map.each.dist %>%
  mutate(Map = ifelse((Map == 1 & Player == "B")|(Map == 5 & Player =="A"), "Gerry Advantaged",
                      ifelse((Map == 1 & Player == "A")|(Map == 5 & Player == "B"),"Gerry Disadvantaged",
                             ifelse(Map == 2, "Symm_1_1",
                                    ifelse(Map == 3, "Symm_1_3", "Symm_3_1")))),
         District = ifelse(District == "EDG", "Dark Gray",
                           ifelse(District == "ELG", "Light Gray", 
                                  ifelse(District == "EW","White", "Wrong"))))

for.plot.of.ts.each.map.and.district <- ts.each.map.each.dist %>%  filter(Period >= 15, Period <=24) %>% group_by(Period, Map, District) %>% summarise(avg.Effort = mean(Effort))

# For Figure 3 please make the following cosmetic changes: a) make the lines thinner √, b) make white dot dot rather than dash dot √, c) make background white not gray , d) remove the labels from inside the figure and put labels on the panels, e) put just gerrymandered treatments on first row and sym treatments on second row with each row centered, f) Use treatment names as shown in Table 2.
ts.from.01.09.2022 <- ggplot(for.plot.of.ts.each.map.and.district, aes(x=Period, y=avg.Effort, group = District, color = District)) +
  geom_line(aes(linetype=District)) +
  scale_linetype_manual(values=c("solid", "solid","dotted")) +
  scale_color_manual(values=c('#333333','#999999', '#000000'))+
  xlim(1,10) + ylim(0,60) + ylab("Effort") +
  scale_x_discrete(breaks=c(1:10)) +
  theme_bw() +  #drop a mostly white theme on for contrast
  theme(panel.border = element_rect(fill=NA, colour = "black", size=1), legend.title = element_blank(), legend.position="none", text = element_text(size = 12)) +
  facet_wrap(~Map)

ts.by.map.and.district.gerry.adv <- for.plot.of.ts.each.map.and.district %>%
  filter(Map == "Gerry Advantaged") %>%
  ggplot(aes(x=Period, y=avg.Effort, group = District, color = District)) +
  geom_line(aes(linetype=District)) +
  scale_linetype_manual(values=c("solid", "solid","dotted")) +
  scale_color_manual(values=c('#333333','#999999', '#000000'))+
  xlim(1,10) + ylim(0,60) + ylab("Expenditure") +
  scale_x_discrete(breaks=c(1:10)) +
  theme_bw() +  #drop a mostly white theme on for contrast
  theme(panel.border = element_rect(fill=NA, colour = "black", size=1), legend.title = element_blank(), legend.position="none", text = element_text(size = 12))

ts.by.map.and.district.gerry.disadv <- for.plot.of.ts.each.map.and.district %>%
  filter(Map == "Gerry Disadvantaged") %>%
  ggplot(aes(x=Period, y=avg.Effort, group = District, color = District)) +
  geom_line(aes(linetype=District)) +
  scale_linetype_manual(values=c("solid", "solid","dotted")) +
  scale_color_manual(values=c('#333333','#999999', '#000000'))+
  xlim(1,10) + ylim(0,60) + ylab("Expenditure") +
  scale_x_discrete(breaks=c(1:10)) +
  theme_bw() +  #drop a mostly white theme on for contrast
  theme(panel.border = element_rect(fill=NA, colour = "black", size=1), legend.title = element_blank(), legend.position="right", text = element_text(size = 12))

ts.by.map.and.district.sym11 <- for.plot.of.ts.each.map.and.district %>%
  filter(Map == "Symm_1_1") %>%
  ggplot(aes(x=Period, y=avg.Effort, group = District, color = District)) +
  geom_line(aes(linetype=District)) +
  scale_linetype_manual(values=c("solid", "solid","dotted")) +
  scale_color_manual(values=c('#333333','#999999', '#000000'))+
  xlim(1,10) + ylim(0,60) + ylab("Expenditure") +
  scale_x_discrete(breaks=c(1:10)) +
  theme_bw() +  #drop a mostly white theme on for contrast
  theme(panel.border = element_rect(fill=NA, colour = "black", size=1), legend.title = element_blank(), legend.position="none", text = element_text(size = 12))

ts.by.map.and.district.sym13 <- for.plot.of.ts.each.map.and.district %>%
  filter(Map == "Symm_1_3") %>%
  ggplot(aes(x=Period, y=avg.Effort, group = District, color = District)) +
  geom_line(aes(linetype=District)) +
  scale_linetype_manual(values=c("solid", "solid","dotted")) +
  scale_color_manual(values=c('#333333','#999999', '#000000'))+
  xlim(1,10) + ylim(0,60) + ylab("Expenditure") +
  scale_x_discrete(breaks=c(1:10)) +
  theme_bw() +  #drop a mostly white theme on for contrast
  theme(panel.border = element_rect(fill=NA, colour = "black", size=1), legend.title = element_blank(), legend.position="none", text = element_text(size = 12))

ts.by.map.and.district.sym13.alternative <- for.plot.of.ts.each.map.and.district %>%
  filter(Map == "Symm_1_3") %>%
  ggplot(aes(x=Period, y=avg.Effort, group = District, color = District)) +
  geom_line(aes(linetype=District)) +
  scale_linetype_manual(values=c("solid", "solid","dotted")) +
  scale_color_manual(values=c('#333333','#999999', '#000000'))+
  xlim(1,10) + ylim(0,60) + ylab("Expenditure") +
  scale_x_discrete(breaks=c(1:10)) +
  theme_bw() +  #drop a mostly white theme on for contrast
  theme(panel.border = element_rect(fill=NA, colour = "black", size=1), legend.title = element_blank(), legend.position="none", text = element_text(size = 12))

ts.by.map.and.district.sym31 <- for.plot.of.ts.each.map.and.district %>%
  filter(Map == "Symm_3_1") %>%
  ggplot(aes(x=Period, y=avg.Effort, group = District, color = District)) +
  geom_line(aes(linetype=District)) +
  scale_linetype_manual(values=c("solid", "solid","dotted")) +
  scale_color_manual(values=c('#333333','#999999', '#000000'))+
  xlim(1,10) + ylim(0,60) + ylab("Expenditure") +
  scale_x_discrete(breaks=c(1:10)) +
  theme_bw() +  #drop a mostly white theme on for contrast
  theme(panel.border = element_rect(fill=NA, colour = "black", size=1),legend.title = element_blank(), legend.position="none", text = element_text(size = 12))

# saved with width 300 height 175
ts.by.map.and.district.gerry.adv
ts.by.map.and.district.gerry.disadv # only one with 300 and 210
ts.by.map.and.district.sym11
ts.by.map.and.district.sym13
ts.by.map.and.district.sym13.alternative
ts.by.map.and.district.sym31
```

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
pct.dis.win.df <- ts.each.map.each.dist %>%
  filter(District == "EW")
```


The following looks at the time series plots for only non-competitive districts to support our claim that a learning effect exists.

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
time_series_avg_noncompetitive <- df_clean %>% 
  filter((Map == 1 | Map == 5 | Map == 2 | Map == 3) & District == c("EDG","ELG")) %>% 
  dplyr::select(Session, Period, subject.id, Player, Map, District, Effort) %>% 
  mutate(Choice = ifelse(Map == 1 & District == "EDG", "Gerry_B EDG", 
                         ifelse(Map == 1 & District == "ELG", "Gerry_B ELG",
                                ifelse(Map == 5 & District == "EDG", "Gerry_A EDG",
                                       ifelse(Map == 5 & District == "ELG", "Gerry_A ELG",
                                              ifelse(Map == 3 & District == "EDG", "Symm_1_3 EDG",
                                                     ifelse(Map == 3 & District == "ELG", "Symm_1_3 ELG",
                                                     ifelse(Map == 2 & District == "EDG", "Symm_1_1 EDG","Symm_1_1 ELG"))))))))

# Get averages for advantages in map 1 or 5, disadvantaged in map 1 or 5, white in map 2 or 3, and all districts in map 4
session.level.ts.avgs.noncompetitive <- time_series_avg_noncompetitive %>% 
  filter(Period < 29) %>% 
  group_by(Session, Period, Choice) %>% summarise(avg.Effort = mean(as.numeric(Effort)))


## These time series plots are only efforst of the competitive districts. We should also look at non competitive districts to determine if a learning effect is evident.
session.level.ts.avgs.noncompetitive %>%
  ggplot(aes(x=Period, y=avg.Effort)) +
  geom_line(aes(color = as.character(Session))) + facet_wrap(~Choice) + xlim(15,27) + ylim(0,60) +
    scale_x_continuous(breaks=c(15:29))

time_series_avg_noncompetitive %>% 
  filter(Period < 25) %>% 
  group_by(Period, Choice) %>% summarise(avg.Effort = mean(as.numeric(Effort))) %>%
  ggplot(aes(x=Period, y=avg.Effort)) +
  geom_line() + 
  facet_wrap(~Choice) + xlim(15,27) + ylim(0,60) +
    scale_x_continuous(breaks=c(15:29))
```
NOTE: We might wish to figure out if only a few bad eggs are driving these contributions to noncompetitive districts.

[DONE]- A small cosmetic point is to make sure you keep the x-axis fixed to make comparisons between graphs easier.  It is not a big deal for this, just something to do in general. In the first part of the document you have some that include 80 and some that don’t. 

[DONE]- Average bid on each district on each map by role

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
print.data.frame(avg.bid.map.district)
```

[DONE]- Percent gerrymandering in stage 2


ISSUE: there seems to be a discrepency in how this is being calculated and it is coming from the use of "ties = 'random'" in the modal() command.

ISSUE RESOLVED
```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
mode_df$gerry <- ifelse((mode_df$Player == 'A' & mode_df$mode.map == 5)|(mode_df$Player == 'B' & mode_df$mode.map == 1),1,0)
sum(mode_df$Player == "A" & mode_df$mode.map == 1)
sum(mode_df$gerry)
pct.gerry <- sum(mode_df$gerry)/64
pct.gerry

# Figure out pct of subjects gerrymandering without including those that never converge on a map
mode_df %>% filter(selection.tie == 0) %>% 
  group_by(gerry) %>%
  summarise(count = n())
# stage_2 <- stage_2 %>% mutate(gerry = ifelse((Player == 'A' & Map_Selection == 5)|(Player == 'B' & Map_Selection == 1),1,0))
# pct.gerry.2 <- sum(stage_2$gerry)/nrow(stage_2)
# pct.gerry.2


```

[DONE]- Percentage picking each map in stage 3
```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
stage_3 <- df %>% subset(Period == 28) %>% 
  dplyr::select(Session, Subject, Period, Player, Map_Selection) %>% 
  mutate(subject.id = Session*8-(8-Subject))

by_map_selection_count <- stage_3 %>% group_by(Map_Selection) %>% tally()
by_map_selection_count$pct.of.pop <- round((by_map_selection_count$n/sum(by_map_selection_count$n))*100, 0)
print.data.frame(by_map_selection_count)
```

*************

[DONE]- Rank sum test looking at whether or not their political views influence whether they gerrymander or not...?

Before the rank sum test let's recall the PEQ relevant for the test.

PEQ_7: "On a scale of 1 to 9, how would you describe your political views with 1 being extremely liberal (i.e. to the left of the Democratic Party), 5 being centrist (i.e. falling between the Democratic Party and the Republican Party), and 9 being extremely conservative (i.e. to the right of the Republican party)." (multiple choice; 1 - 9)

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
# really just need response for each subject to include on the simplified data
# so just pull in their responses...
peq_response <- read_excel("PEQ_Responses.xlsx") %>%
  dplyr::select(Session, Period, Subject,PEQ_7,TimeSubmitPEQ7OK, PEQ_8) %>%
  mutate(subject.id = as.numeric(Session)*8-(8-as.numeric(Subject)))

# and join to gerry table
gerry_and_politics <- right_join(mode_df, peq_response, copied = F) %>%
  dplyr::select(Session, subject.id, PEQ_7, PEQ_8, gerry) %>%
  mutate(support_gerry = ifelse(PEQ_8 == 1, "Yes", "No"),
         gerry.character = ifelse(gerry == 1,"Did Gerrymander","Did not Gerrymander"))

# ggplot(transform(
#   gerry_and_politics, gerry.character=factor(gerry.character, levels=c("Did Gerrymander","Did not Gerrymander"))
#   ), 
#    aes(x = PEQ_7)) + 
#   geom_histogram(aes(fill = as.character(support_gerry))) +
#   geom_text(aes(label = ..count..), stat = "count", vjust = 1.5, size = 3, colour = "white")+
#   labs(fill = "Do you support gerrymandering?") +
#   facet_wrap(~gerry.character) + xlim(1,9) + scale_x_continuous(breaks=c(1:9)) + 
#   labs(title = "Political Leaning and Gerrymandering",
#        caption = "The left and right panels represent political self-identification \n for participants who did and did not, respectively, engage in gerrymandering through map selection. \n The coloring identifies those who stated they did or didnot support gerrymandering.")

# > stage3_map <- last_period.v1 %>% filter(renamed.map.selection != "No Selection") %>%
# +   ggplot(aes(x=renamed.map.selection)) +
# +   geom_bar(aes(y = (..count..)/sum(..count..)),width = 0.5, alpha = 0.5, position="identity", fill = "#666666") +
# +   #geom_text(aes(label = ..count..), stat = "count", vjust = 1.5, colour = "black", size = 8) +
# +   xlab("") + ylab("") +
# +   scale_y_continuous(labels=scales::percent) +
# +   scale_x_discrete(labels=c('Symm_1_1'= parse(text = TeX('$Sym_{1,1}$')),
# +                             'Symm_1_3'= parse(text = TeX('$Sym_{1,3}$')),
# +                             'Symm_3_1'= parse(text = TeX('$Sym_{3,1}$')),
# +                             'Gerry_A'= parse(text = TeX('$Gerry_A$')),
# +                             'Gerry_B'= parse(text = TeX('$Gerry_B$'))))
# > stage3_map + theme(axis.text.x = element_text(size = 20), axis.text.y = element_text(size = 20))
# \textcolor{red}{For Figure \ref{fig:gerry_and_politics} rather than using counts, please use percentages.  Also, do not put the numbers in the bars as that is hard to read in a printout. We do not need to label the percentages on each bar.  Please make sure the color choices print out nicely in black and white or use black and white bars.  Please capitalize not in Did Not Gerrymander. }
gerry_and_politics$gerry.character[gerry_and_politics$gerry.character=="Did not Gerrymander"] <- "Did Not Gerrymander"

ggplot(transform(
  gerry_and_politics, gerry.character=factor(gerry.character, levels=c("Did Gerrymander", "Did Not Gerrymander"))
  ), aes(x=PEQ_7, fill = as.character(support_gerry))) + 
  geom_bar(aes(y = (..count..)/sum(..count..)), width = 0.5, alpha = 1, position="identity") +
  #geom_text(aes(label = ..count..), stat = "count", vjust = 1.5, size = 8, colour = "white") +
  facet_wrap(~gerry.character) + 
  xlim(1,9) + 
  scale_x_continuous(breaks=c(1:9)) +
  labs(x = "Left to Right Political Identification", y = "") +
  labs(fill = "Do you support gerrymandering?") + ylim(1,9) + 
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = c("No"="gray","Yes"="black"))
       #title = "Political Leaning and Gerrymandering"
       #caption = "The left and right panels represent political self-identification \n for participants who did and did not, respectively, engage in gerrymandering through map selection. \n The coloring identifies those who stated they did or didnot support gerrymandering.")

# combined.bar <- ggplot(mode_df.v1, aes(x=renamed.mode.map)) + 
#   geom_bar(width = 0.5, alpha = 0.5, position="identity", fill = "#FF6666") +
#   geom_text(aes(label = ..count..), stat = "count", vjust = 1.5, colour = "black", size = 8) +
#   xlab("") + ylab("")
# combined.bar + theme(axis.text.x = element_text(size = 20), axis.text.y = element_text(size = 20))


political.leaning <- ggplot(gerry_and_politics, aes(x = PEQ_7)) +
  geom_bar(width = 0.4, alpha = 0.5, position = "identity", fill = "#FF6666") +
  geom_text(aes(label = ..count..), stat = "count", vjust = 1.5, colour = "black", size = 8) + 
  xlim(0,10) + ylab("")

# aes(fill = "PEQ_8", fill = "PEQ_8", fill = "#FF6666")) +
#   xlim(1,9) + scale_x_continuous(breaks=c(1:9))
political.leaning + xlim(1,9) + scale_x_continuous(breaks=c(1:9))

nrow(subset(gerry_and_politics, PEQ_7 > 5))

nrow(subset(gerry_and_politics, PEQ_7 < 5))

sum(gerry_and_politics$gerry)/nrow(gerry_and_politics)

## TO MAKE
##### stacked figure: they do gerrymandering and they don't gerrymander
```

Now, onto the rank sum test.

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
rank_res_gerryied <- wilcox.test(PEQ_7 ~ as.character(gerry), data = gerry_and_politics,
                   exact = FALSE)
rank_res_gerryied
```

So we fail to reject the null that the political preference is the same regardless of whether they actually gerrymandered.

What about based on whether they *support* gerrymandering? (a.k.a PEQ_8)

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
rank_res_support.gerry <- wilcox.test(PEQ_7 ~ support_gerry, data = gerry_and_politics,
                   exact = FALSE)
rank_res_support.gerry
```

Also fail to reject the null that political preference is the same regardless of whether they support gerrymandering.

[DONE]- political beliefs and saying gerrymandering (**done above**; no diff. between gerrymandering and politics)

[DONE]- how either of those answers depend on whether they actually gerrymander (**above** = no diff. b/w support gerry and politics; **below** = no diff in support of gerrymandering based on whether actually gerry)

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
rank_support.gerry_actually.gerry <- wilcox.test(PEQ_8 ~ as.character(gerry), data = gerry_and_politics, exact = FALSE)
rank_support.gerry_actually.gerry

# wilcox.test(gerry ~ support_gerry, data = gerry_and_politics, exact = FALSE)
```


[DONE]- Z test of whether observations are same for number of people selecting whether they support gerrymandering or not (same # of people in both camps; probably going to be diff given the distribution between y and n)

This is a two sample t-test I believe.
(^In Sig.)



[DONE]- Of the people who say they don't support it, what % actually did it

```{r}
nrow(subset(gerry_and_politics, PEQ_8 == 2 & gerry == 1))/nrow(subset(gerry_and_politics, PEQ_8 == 2))
```



[DONE]- for the same split, did they say they like gerrymandering or not proportionately (are the proportions the same) ????????? Only have 3 that say support gerrymandering... is this enough to make any determination?

(Do you like it as a function of whether you actually did it)

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
gerry_and_politics <- gerry_and_politics %>% 
  mutate(support_gerry_numeric = ifelse(support_gerry == "No", 0, 1))

nrow(subset(gerry_and_politics, gerry == 1 & gerry_and_politics$support_gerry == "Yes"))/nrow(subset(gerry_and_politics, gerry == 1))

nrow(subset(gerry_and_politics, gerry == 0 & gerry_and_politics$support_gerry == "Yes"))/nrow(subset(gerry_and_politics, gerry == 0))
```

This is for the bar graph

  - when they don't know who they are which maps are they choosing
  - distinguish b/w people choosing gerrymandered map based on if they are choosing it after having chosen it in previous periods
  - 4 bars; gerrymander A and B on one column (two colored bars; one color is "gerrymandered for self" other color "gerrymandered for other")
  - Some people like gerrymandered maps even not knowing who they are
  - Some pick gerrymander for self (have been picking the map for themselves in previous round)
  
```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
mode_df_with_end <- inner_join(mode_df,stage_3, copied = F) %>%
  rename(final.map.choice = Map_Selection) %>%
  mutate(spillover = ifelse(mode.map == final.map.choice & gerry == 1, "Spillover", "No Spillover"))



mode_df_with_end <- mode_df_with_end[!(mode_df_with_end$final.map.choice == -99),]

mode_df_with_end <- mode_df_with_end %>%
  mutate(final.map.choice = ifelse(final.map.choice==1, "Gerry_B",
                                   ifelse(final.map.choice==2, "Symm_1_1",
                                          ifelse(final.map.choice==3, "Symm_1_3",
                                                 ifelse(final.map.choice==4, "Symm_3_1", "Gerry_A")))))

mode_df_with_end <- mode_df_with_end %>%
  mutate(mode.map = ifelse(mode.map==1, "Gerry_B",
                                   ifelse(mode.map==2, "Symm_1_1",
                                          ifelse(mode.map==3, "Symm_1_3",
                                                 ifelse(mode.map==4, "Symm_3_1", "Gerry_A")))))

#combine maps 1 and 5. Only color maps based off if they are potential spillovers
mode_df_with_end <- mode_df_with_end %>%
  mutate(adjusted.map.mode = ifelse(mode.map == 'Gerry_A' | mode.map == 'Gerry_B', "Gerry A or B", as.character(mode.map)),
         adjusted.final.map.choice = 
           ifelse(final.map.choice == "Gerry_A" | final.map.choice == "Gerry_B", "Gerry A or B", as.character(final.map.choice)))

map_mode_with_end_bar <- 
  ggplot(mode_df_with_end, aes(x=adjusted.final.map.choice, fill = spillover, color = spillover)) +
  geom_bar(width = 0.5, alpha = 0.5, position="identity")
map_mode_with_end_bar + labs(title = "Map Choice in Final Period",
                             subtitle = "Spillover includes only those who actually gerrymandered and chose their previously advantaged map both in stage 2 and stage 3")+
  geom_text(aes(label = ..count..), stat = "count", vjust = 1.5, colour = "white")
  
```


[DONE]- Regression from Deck's notes

\[Effort = \alpha + \beta_1 Player_B + \beta_2 Map_2 + \beta_3 Map_2 Player_B + \beta_4 Map_3 + \beta_5 Map_3 Player_B + \beta_6 Map_4 + \beta_7 Map_4 Player_B + \beta_8 Map_5 + \beta_9 Map_5 Player_B\]

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
#long_df <- df %>% dplyr::select(Session, Period, Subject, Player, Partner, LType, EDG_5:EW_1, pEDG_5:pEW_1) #%>% gather(District, Effort, EDG_5:pEW_1)

regress_df <- df %>% dplyr::select(Session, Period, Subject, Player, TE_1:TE_5) %>%
  filter(Period <= 24) %>%
  gather(Map, Effort, TE_1:TE_5)


regress_df <- regress_df %>% mutate(subject.id = Session*8-(8-Subject),
                                    Player_B = ifelse(Player== "B", 1, 0),
         Gerry_B = ifelse(Map == "TE_1", 1, 0),
         Symm_1_1 = ifelse(Map == "TE_2", 1, 0),
         Symm_1_3 = ifelse(Map == "TE_3", 1, 0),
         Symm_3_1 = ifelse(Map == "TE_4", 1, 0),
         Gerry_A = ifelse(Map == "TE_5", 1, 0),
         Adv = ifelse((Map == "TE_1" & Player == "B")|(Map == "TE_5" & Player == "A"), 1,0),
         Disadv = ifelse((Map == "TE_1" & Player == "A")|(Map == "TE_5" & Player == "B"), 1,0),
         Stage_2_indicator = ifelse((Period > 24 & Period < 28), 1, 0))
         
         #subject.id = Session*8-(8-Subject)


# want to use map 2 as baseline...?? Did we decide on this or not...
map.player.interaction <- lm(
  Effort ~ Player_B + Gerry_B + Gerry_B*Player_B + Symm_1_3 + Symm_1_3*Player_B + Symm_3_1 + Symm_3_1*Player_B
  + Gerry_A + Gerry_A*Player_B,
  data = regress_df
  )

summary(map.player.interaction, robust = T)
#summary(map.adv.interaction)
```

Making better tables.

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
stargazer(map.player.interaction, title = "Model 1 Regression Results", single.row = T)
```



The below tells us the role does not really matter.

```{r}

#linearHypothesis(map.player.interaction, c("Gerry_A + Player_B:Gerry_A = 0"))
linearHypothesis(map.player.interaction, c("Player_B + Player_B:Symm_1_3 = 0")) ## in sig at 5%
linearHypothesis(map.player.interaction, c("Player_B + Player_B:Symm_3_1 = 0")) ## in sig at 5%
linearHypothesis(map.player.interaction, c("Player_B + Player_B:Symm_1_3 = 0", "Player_B + Player_B:Symm_3_1 = 0", "Player_B = 0"))

linearHypothesis(map.player.interaction, c("Player_B + Gerry_B + Player_B:Gerry_B = Gerry_A"))
linearHypothesis(map.player.interaction, c("Player_B + Gerry_A + Player_B:Gerry_A = Gerry_B"))

linearHypothesis(map.player.interaction, c(
  "Player_B + Gerry_B + Player_B:Gerry_B = Gerry_A", "Player_B + Gerry_A + Player_B:Gerry_A = Gerry_B" ,"Player_B + Player_B:Symm_1_3 = 0", "Player_B + Player_B:Symm_3_1 = 0", "Player_B = 0")
  )
```

Justified ignoring player role in comparing treatments since the joint test (that player A and B play the same) is not rejected.

```{r}
regress_df <- df %>% dplyr::select(Session, Period, Subject, Player, TE_1:TE_5) %>%
  filter(Period >= 15 & Period < 25) %>%
  gather(Map, Effort, TE_1:TE_5)


regress_df <- regress_df %>% mutate(subject.id = Session*8-(8-Subject),
                                    Player_B = ifelse(Player== "B", 1, 0),
         Gerry_B = ifelse(Map == "TE_1", 1, 0),
         Symm_1_1 = ifelse(Map == "TE_2", 1, 0),
         Symm_1_3 = ifelse(Map == "TE_3", 1, 0),
         Symm_3_1 = ifelse(Map == "TE_4", 1, 0),
         Gerry_A = ifelse(Map == "TE_5", 1, 0),
         Adv = ifelse((Map == "TE_1" & Player == "B")|(Map == "TE_5" & Player == "A"), 1,0),
         Disadv = ifelse((Map == "TE_1" & Player == "A")|(Map == "TE_5" & Player == "B"), 1,0),
         Stage_2_indicator = ifelse((Period > 24 & Period < 28), 1, 0))

map.adv.interaction <- lm(
  Effort ~ Adv + Disadv + Symm_1_3 + Symm_3_1 + Period + Adv*Period + Disadv*Period + Symm_1_3*Period + Symm_3_1*Period,
  data = regress_df
  )

summary(map.adv.interaction)
stargazer(map.adv.interaction, title = "Model 3 Regression Results", single.row = T)
```

```{r}
linearHypothesis(map.adv.interaction, c("Symm_1_3 = 10"))
linearHypothesis(map.adv.interaction, c("Symm_3_1 = 10")) # so map 4 is pushing expenditure up, but not as much as theory predicts

linearHypothesis(map.adv.interaction, c("Symm_1_3 = Symm_3_1")) # map 4 has a larger effect than map 3 even though they're predicted to have the same effect (as shown by regression, but still worth testing)

linearHypothesis(map.adv.interaction, c("Adv = Disadv"))


# testing on periods
linearHypothesis(map.adv.interaction, c("Adv:Period = 0", "Disadv:Period = 0", "Symm_1_3:Period = 0", "Symm_3_1:Period = 0", "Period = 0"))
```



[Done?]- Regression of average bid as function of period with dummy variable for Map selection phase (periods 25,26,27)


(so we just want the impact on the map selection phase on the average map level bids)

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}

## updating period to include stage 2 here

regress_df <- df %>% dplyr::select(Session, Period, Subject, Player, TE_1:TE_5) %>%
  filter(Period >= 15 & Period <= 27) %>%
  gather(Map, Effort, TE_1:TE_5)


regress_df <- regress_df %>% mutate(subject.id = Session*8-(8-Subject),
                                    Player_B = ifelse(Player== "B", 1, 0),
         Gerry_B = ifelse(Map == "TE_1", 1, 0),
         Symm_1_1 = ifelse(Map == "TE_2", 1, 0),
         Symm_1_3 = ifelse(Map == "TE_3", 1, 0),
         Symm_3_1 = ifelse(Map == "TE_4", 1, 0),
         Gerry_A = ifelse(Map == "TE_5", 1, 0),
         Adv = ifelse((Map == "TE_1" & Player == "B")|(Map == "TE_5" & Player == "A"), 1,0),
         Disadv = ifelse((Map == "TE_1" & Player == "A")|(Map == "TE_5" & Player == "B"), 1,0),
         Stage_2_indicator = ifelse((Period > 24 & Period < 28), 1, 0))

stage_2_impact <- lm(
  Effort ~ Adv + Disadv + Symm_1_3 + Symm_3_1 + Stage_2_indicator + Adv*Stage_2_indicator + Disadv*Stage_2_indicator + Symm_1_3*Stage_2_indicator + Symm_3_1*Stage_2_indicator,
  data = regress_df
  )

summary(stage_2_impact)
stargazer(stage_2_impact, title="Model 2 Regression Results", single.row = T)

regress_df2 <- regress_df %>% filter(Period < 25)
map_impact <- lm(
  Effort ~ Adv + Disadv + Symm_1_3 + Symm_3_1,
  data = regress_df2
  )
stargazer(map_impact, title = "Effect of Map Configuration on Total Bid in Stage 1", single.row = T)
```

```{r}


linearHypothesis(stage_2_impact, c("Symm_1_3 = 10"))
linearHypothesis(stage_2_impact, c("Symm_3_1 = 10"))
linearHypothesis(stage_2_impact, c("Symm_1_3 = Symm_3_1"))

linearHypothesis(stage_2_impact, c("Adv:Stage_2_indicator = 0", "Disadv:Stage_2_indicator = 0",
                                   "Symm_1_3:Stage_2_indicator = 0", "Symm_3_1:Stage_2_indicator = 0"))


linearHypothesis(map_impact, c("Adv" = "Disadv"))
```

\newpage

<!---->
<!---->
<!---->
<!---->
<!---->
<!---->
<!---->
<!---->
<!---->
<!---->
<!---->
<!---->
<!---->
<!---->


Redo the regressions and tests with the data from only 20 through 24 (second half of stage 1) to account for potential learning. this is because the period coefficient shows a downward trend over time.

Below are the regressions and tests using only the last 5 periods from the first stage:

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
regress_df <- df %>% dplyr::select(Session, Period, Subject, Player, TE_1:TE_5) %>%
  filter(Period >= 20 & Period <= 24) %>%
  gather(Map, Effort, TE_1:TE_5)


regress_df <- regress_df %>% mutate(subject.id = Session*8-(8-Subject),
                                    Player_B = ifelse(Player== "B", 1, 0),
         Gerry_B = ifelse(Map == "TE_1", 1, 0),
         Symm_1_1 = ifelse(Map == "TE_2", 1, 0),
         Symm_1_3 = ifelse(Map == "TE_3", 1, 0),
         Symm_3_1 = ifelse(Map == "TE_4", 1, 0),
         Gerry_A = ifelse(Map == "TE_5", 1, 0),
         Adv = ifelse((Map == "TE_1" & Player == "B")|(Map == "TE_5" & Player == "A"), 1,0),
         Disadv = ifelse((Map == "TE_1" & Player == "A")|(Map == "TE_5" & Player == "B"), 1,0),
         Stage_2_indicator = ifelse((Period > 24 & Period < 28), 1, 0))
         
map.player.interaction.adj <- lm(
  Effort ~ Player_B + Gerry_B + Gerry_B*Player_B + Symm_1_3 + Symm_1_3*Player_B + Symm_3_1 + Symm_3_1*Player_B
  + Gerry_A + Gerry_A*Player_B,
  data = regress_df
  )

summary(map.player.interaction.adj)
stargazer(map.player.interaction, map.player.interaction.adj, title = "Model 1 Regression Results", column.labels = c("w/out learning", "w/ learning"), label = "Tab:regression_1", single.row = T)
```

and the tests for this regression:

```{r}
#linearHypothesis(map.player.interaction, c("Map_5 + Player_B:Map_5 = 0"))
linearHypothesis(map.player.interaction.adj, c("Player_B + Player_B:Symm_1_3 = 0")) ## in sig at 5%
linearHypothesis(map.player.interaction.adj, c("Player_B + Player_B:Symm_3_1 = 0")) ## in sig at 5%
linearHypothesis(map.player.interaction.adj, c("Player_B + Player_B:Symm_1_3 = 0", "Player_B + Player_B:Symm_3_1 = 0", "Player_B = 0"))

linearHypothesis(map.player.interaction.adj, c("Player_B + Gerry_B + Player_B:Gerry_B = Gerry_A"))
linearHypothesis(map.player.interaction.adj, c("Player_B + Gerry_A + Player_B:Gerry_A = Gerry_B"))

linearHypothesis(map.player.interaction.adj, c(
  "Player_B + Gerry_B + Player_B:Gerry_B = Gerry_A", "Player_B + Gerry_A + Player_B:Gerry_A = Gerry_B" ,"Player_B + Player_B:Symm_1_3 = 0", "Player_B + Player_B:Symm_3_1 = 0", "Player_B = 0")
  )
```

The above tests allow us to ignore player role given the null hypothesis that players A and B do not differ in their behavior.

That is, we can run:

```{r}
regress_df <- df %>% dplyr::select(Session, Period, Subject, Player, TE_1:TE_5) %>%
  filter(Period >= 20 & Period <= 24) %>%
  gather(Map, Effort, TE_1:TE_5)


regress_df <- regress_df %>% mutate(subject.id = Session*8-(8-Subject),
                                    Player_B = ifelse(Player== "B", 1, 0),
         Gerry_B = ifelse(Map == "TE_1", 1, 0),
         Symm_1_1 = ifelse(Map == "TE_2", 1, 0),
         Symm_1_3 = ifelse(Map == "TE_3", 1, 0),
         Symm_3_1 = ifelse(Map == "TE_4", 1, 0),
         Gerry_A = ifelse(Map == "TE_5", 1, 0),
         Adv = ifelse((Map == "TE_1" & Player == "B")|(Map == "TE_5" & Player == "A"), 1,0),
         Disadv = ifelse((Map == "TE_1" & Player == "A")|(Map == "TE_5" & Player == "B"), 1,0),
         Stage_2_indicator = ifelse((Period > 24 & Period < 28), 1, 0))

map.adv.interaction.adj <- lm(
  Effort ~ Adv + Disadv + Symm_1_3 + Symm_3_1 + Period + Adv*Period + Disadv*Period + Symm_1_3*Period + Symm_3_1*Period,
  data = regress_df
  )

summary(map.adv.interaction.adj)
stargazer(map.adv.interaction, map.adv.interaction.adj, title = "Model 3 Regression Results", column.labels = c("w/out learning", "w/ learning"), label = "Tab:regression_3", single.row = T)

```

with tests:

```{r}
linearHypothesis(map.adv.interaction.adj, c("Symm_1_3 = 10"))
linearHypothesis(map.adv.interaction.adj, c("Symm_3_1 = 10")) # so map 4 is pushing expenditure up, but not as much as theory predicts

linearHypothesis(map.adv.interaction.adj, c("Symm_1_3 = Symm_3_1")) # map 4 has a larger effect than map 3 even though they're predicted to have the same effect (as shown by regression, but still worth testing)

linearHypothesis(map.adv.interaction.adj, c("Adv = Disadv"))

# testing on periods
linearHypothesis(map.adv.interaction.adj, c("Adv:Period = 0", "Disadv:Period = 0", "Symm_1_3:Period = 0", "Symm_3_1:Period = 0", "Period = 0"))
```

Now, let's look specifically at the effect of map selection.

First, look only at Stage 1 data

```{r Stage_1_regressions, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
stage_1_regression_data <- df %>% dplyr::select(Session, Period, Subject, Player, TE_1:TE_5) %>%
  filter(Period >= 15 & Period <= 24) %>%
  gather(Map, Effort, TE_1:TE_5)
stage_1_regression_data <- stage_1_regression_data %>% mutate(subject.id = as.factor(Session*8-(8-Subject)),
                                    Player_B = ifelse(Player== "B", 1, 0),
         Gerry_B = ifelse(Map == "TE_1", 1, 0),
         Symm_1_1 = ifelse(Map == "TE_2", 1, 0),
         Symm_1_3 = ifelse(Map == "TE_3", 1, 0),
         Symm_3_1 = ifelse(Map == "TE_4", 1, 0),
         Gerry_A = ifelse(Map == "TE_5", 1, 0),
         Adv = ifelse((Map == "TE_1" & Player == "B")|(Map == "TE_5" & Player == "A"), 1,0),
         Disadv = ifelse((Map == "TE_1" & Player == "A")|(Map == "TE_5" & Player == "B"), 1,0),
         Stage_2_indicator = ifelse((Period > 24 & Period < 28), 1, 0) # this is currently useless (all zeros)
         )

stage_1_regression_data_with_learnng <- stage_1_regression_data %>% filter(Period >=20)
##########
map_impact_on_stage_1_no_learning <-lm(Effort ~ Adv + Disadv + Symm_1_3 + Symm_3_1, data = stage_1_regression_data)

map_impact_on_stage_1_with_learning <-lm(Effort ~ Adv + Disadv + Symm_1_3 + Symm_3_1, data = stage_1_regression_data_with_learnng)
########

# Look at subject Fixed Effects and standard errors clustered at session level
########
map_impact_on_stage_1_no_learning_FE <-lm(Effort ~ Adv + Disadv + Symm_1_3 + Symm_3_1 + subject.id, data = stage_1_regression_data)

map_impact_on_stage_1_with_learning_FE <-lm(Effort ~ Adv + Disadv + Symm_1_3 + Symm_3_1 + subject.id, data = stage_1_regression_data_with_learnng)

##########
#summary(map_impact_on_stage_1_no_learning)
#summary(map_impact_on_stage_1_with_learning)
#summary(map_impact_on_stage_1_no_learning_FE)
#summary(map_impact_on_stage_1_with_learning_FE)

#stargazer(map_impact_on_stage_1_no_learning, map_impact_on_stage_1_with_learning, title = "Map Impact on Stage 1 Bidding", column.labels = c("w/out learning", "w/ learning"), label = "Tab:stage_1_with_and_without_learning", single.row = T)

stargazer(map_impact_on_stage_1_no_learning_FE,
          map_impact_on_stage_1_with_learning_FE,
          title = "Map Impact on Stage 1 Bidding (FE and Clustereed SE)",
          column.labels = c("w/out learning", "w/ learning"),
          label = "Tab:stage_1_with_and_without_learning_FE_CSE",
          omit = "subject.id", single.row = T)

# Must fill in clustered SE manually; can't figure out how to do this in Stargazer
map_impact_on_stage_1_no_learning_FE <-lm.cluster(Effort ~ Adv + Disadv + Symm_1_3 + Symm_3_1 + subject.id, cluster = "Session", data = stage_1_regression_data)
summary(map_impact_on_stage_1_no_learning_FE)
#summary(reg,cluster = c("class_id"))

map_impact_on_stage_1_with_learning_FE <-lm.cluster(Effort ~ Adv + Disadv + Symm_1_3 + Symm_3_1 + subject.id, cluster = "Session", data = stage_1_regression_data_with_learnng)
summary(map_impact_on_stage_1_with_learning_FE)

# Tests with NO LEARNING
linearHypothesis(map_impact_on_stage_1_no_learning_FE, c("Adv = Disadv"))
#linearHypothesis(map_impact_on_stage_1_no_learning_FE, c("Symm_1_3 = 0"))
linearHypothesis(map_impact_on_stage_1_no_learning_FE, c("Symm_1_3 = 10"))
#linearHypothesis(map_impact_on_stage_1_no_learning_FE, c("Symm_3_1 = 0"))
linearHypothesis(map_impact_on_stage_1_no_learning_FE, c("Symm_3_1 = 10"))
linearHypothesis(map_impact_on_stage_1_no_learning_FE, c("Symm_1_3 = Symm_3_1"))

# Tests WITH LEARNING
linearHypothesis(map_impact_on_stage_1_with_learning, c("Adv = Disadv"))
#linearHypothesis(map_impact_on_stage_1_with_learning, c("Symm_1_3 = 0"))
linearHypothesis(map_impact_on_stage_1_with_learning, c("Symm_1_3 = 10"))
#linearHypothesis(map_impact_on_stage_1_with_learning, c("Symm_3_1 = 0"))
linearHypothesis(map_impact_on_stage_1_with_learning, c("Symm_3_1 = 10"))
linearHypothesis(map_impact_on_stage_1_with_learning, c("Symm_1_3 = Symm_3_1"))
```


Now, look at stage 2 impact as a dummy variable

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
## updating period to include stage 2 here

regress_df <- df %>% dplyr::select(Session, Period, Subject, Player, TE_1:TE_5) %>%
  filter(Period > 19 & Period <= 27) %>%
  gather(Map, Effort, TE_1:TE_5)


regress_df <- regress_df %>% mutate(subject.id = Session*8-(8-Subject),
                                    Player_B = ifelse(Player== "B", 1, 0),
         Gerry_B = ifelse(Map == "TE_1", 1, 0),
         Symm_1_1 = ifelse(Map == "TE_2", 1, 0),
         Symm_1_3 = ifelse(Map == "TE_3", 1, 0),
         Symm_3_1 = ifelse(Map == "TE_4", 1, 0),
         Gerry_A = ifelse(Map == "TE_5", 1, 0),
         Adv = ifelse((Map == "TE_1" & Player == "B")|(Map == "TE_5" & Player == "A"), 1,0),
         Disadv = ifelse((Map == "TE_1" & Player == "A")|(Map == "TE_5" & Player == "B"), 1,0),
         Stage_2_indicator = ifelse((Period > 24 & Period < 28), 1, 0))

stage_2_impact.adj <- lm(
  Effort ~ Adv + Disadv + Symm_1_3 + Symm_3_1 + Stage_2_indicator + Adv*Stage_2_indicator + Disadv*Stage_2_indicator + Symm_1_3*Stage_2_indicator + Symm_3_1*Stage_2_indicator,
  data = regress_df
  )

summary(stage_2_impact.adj)
stargazer(stage_2_impact, stage_2_impact.adj, title = "Model 2 Regression Results", column.labels = c("w/out learning", "w/ learning"), label = "Tab:regression_2", single.row = T)
```

with joint test:

```{r}
linearHypothesis(stage_2_impact.adj, c("Symm_1_3 = 10")) # can reject this
linearHypothesis(stage_2_impact.adj, c("Symm_3_1 = 10")) # can't reject this (marginally we can)
linearHypothesis(stage_2_impact.adj, c("Symm_3_1 = Symm_1_3")) # can safely reject they are the same
linearHypothesis(stage_2_impact.adj, c("Adv:Stage_2_indicator = 0", "Disadv:Stage_2_indicator = 0",
                                   "Symm_1_3:Stage_2_indicator = 0", "Symm_3_1:Stage_2_indicator = 0"))
```


\newpage


Now, we need to verify the other tests still hold with this sub-sample. We might also be interested in comparing a few tables.

To start:

```{r}
summarize(map_four_bidding, n.records = n(),
          n.all.zeros = sum(all.zeros.bids),
          n.one.district  = sum(one.bids),
          n.two.districts = sum(two.bids),
          n.three.districts = sum(all.three.bids),
          pct.zeros = n.all.zeros/n.records,
          pct.bid.one = n.one.district/n.records,
          pct.bid.two = n.two.districts/n.records,
          pct.bid.three = n.three.districts/n.records,
          )

# compared to 

summarize(subset(map_four_bidding, Period > 19), n.records = n(),
          n.all.zeros = sum(all.zeros.bids),
          n.one.district  = sum(one.bids),
          n.two.districts = sum(two.bids),
          n.three.districts = sum(all.three.bids),
          pct.zeros = n.all.zeros/n.records,
          pct.bid.one = n.one.district/n.records,
          pct.bid.two = n.two.districts/n.records,
          pct.bid.three = n.three.districts/n.records,
          )

# the above have very little difference
```

Now, the K-S tests:

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
# Map 4 Dark Grey
EDG4A <- subset(df_all_cdf, Period > 19 & Map == 4 & District == "EDG" & Player == "A")[,"Effort"]
EDG4B <- subset(df_all_cdf, Period > 19 & Map == 4 & District == "EDG" & Player == "B")[,"Effort"]

ks.test(as.numeric(unlist(EDG4A)),as.numeric(unlist(EDG4B)))

# Map 4 Light Grey
ELG4A <- subset(df_all_cdf, Period > 19 & Map == 4 & District == "ELG" & Player == "A")[,"Effort"]
ELG4B <- subset(df_all_cdf, Period > 19 & Map == 4 & District == "ELG" & Player == "B")[,"Effort"]

ks.test(as.numeric(unlist(ELG4A)),as.numeric(unlist(ELG4B)))

# Map 4 White
EW4A <- subset(df_all_cdf, Period > 19 & Map == 4 & District == "EW" & Player == "A")[,"Effort"]
EW4B <- subset(df_all_cdf, Period > 19 & Map == 4 & District == "EW" & Player == "B")[,"Effort"]

ks.test(as.numeric(unlist(EW4A)),as.numeric(unlist(EW4B)))

# Map 2 White
EW2A <- subset(df_all_cdf, Period > 19 & Map == 2 & District == "EW" & Player == "A")[,"Effort"]
EW2B <- subset(df_all_cdf, Period > 19 & Map == 2 & District == "EW" & Player == "B")[,"Effort"]

ks.test(as.numeric(unlist(EW2A)),as.numeric(unlist(EW2B)))

# Map 3 White
EW3A <- subset(df_all_cdf, Period > 19 & Map == 3 & District == "EW" & Player == "A")[,"Effort"]
EW3B <- subset(df_all_cdf, Period > 19 &Map == 3 & District == "EW" & Player == "B")[,"Effort"]

ks.test(as.numeric(unlist(EW3A)),as.numeric(unlist(EW3B)))

# Advantaged
ADV.A <- subset(dissag.df.overlay, Period > 19 & Advantage == "Adv" & Player == "A")[,"Effort"]
ADV.B <- subset(dissag.df.overlay, Period > 19 & Advantage == "Adv" & Player == "B")[,"Effort"]

ks.test(as.numeric(unlist(ADV.A)),as.numeric(unlist(ADV.B)))

# Disadvantaged
Dis.ADV.A <- subset(dissag.df.overlay, Period > 19 & Advantage == "Dis.adv" & Player == "A")[,"Effort"]
Dis.ADV.B <- subset(dissag.df.overlay, Period > 19 & Advantage == "Dis.adv" & Player == "B")[,"Effort"]

ks.test(as.numeric(unlist(Dis.ADV.A)),as.numeric(unlist(Dis.ADV.B)))

# Adv vs Dis.adv
ADV.All <- subset(dissag.df.overlay, Period > 19 & Advantage == "Adv")[,"Effort"]
Dis.ADV.All <- subset(dissag.df.overlay, Period > 19 & Advantage == "Dis.adv")[,"Effort"]

ks.test(as.numeric(unlist(ADV.All)),as.numeric(unlist(Dis.ADV.All)))
```

## Additions on August 2, 2021
Table with each of 5 maps' 3 districts and percent of bids == 0, average bid if != 0, and the average bid unconditional.

## 1

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
## NOTE: check the Period filter for correctness when analyzing
stage_1.cond <- df %>% filter(Period <= 24 & Period >= 20) %>% dplyr::select(EDG_5:EW_1)
stage_1.cond[stage_1.cond == 0] <- NA
round(colMeans(stage_1.cond, na.rm = T), 2)

stage_1 <- df %>% filter(Period <= 24 & Period >= 20) %>% dplyr::select(EDG_5:EW_1)
round(colMeans(stage_1), 2)


no_partner_stats <- df_clean %>% 
  filter(Period <= 24 & Period >= 15 & !grepl("pE", District)) %>% 
  mutate(Fairness = 
           ifelse((Player == "A" & Map == 5)|(Player == "B" & Map == 1), "Adv", 
                            ifelse((Player == "B" & Map == 5)|(Player == "A" & Map == 1),"Dis.adv", "fair")),
         Map = ifelse(Map == 1 |Map == 5, "gerry", Map),
         EffortWithNAs = ifelse(Effort == 0, NA, Effort))


#no_partner_stats$Effort[no_partner_stats$EffortWithNAs<=0] <- NA
pct.zero.dis.adv <- no_partner_stats %>%
  group_by(District, Map, Fairness) %>%
  summarize(pct.bid.zero = 100*round(sum(is.na(EffortWithNAs))/n(), 2),
            avg.positive.bid = mean(EffortWithNAs, na.rm = T),
            avg.bid          = mean(Effort))
pct.zero.dis.adv


pct.zero.dis.adv.stage.1 <- no_partner_stats %>%
  filter(Period >= 15, Period <= 24) %>%
  group_by(District, Map, Fairness) %>%
  summarize(pct.bid.zero = 100*round(sum(is.na(EffortWithNAs))/n(), 2),
            avg.positive.bid = mean(EffortWithNAs, na.rm = T),
            avg.bid          = mean(Effort))
pct.zero.dis.adv.stage.1

pct.zero.dis.adv.w.learning <- no_partner_stats %>%
  filter(Period >= 20, Period <= 24) %>%
  group_by(District, Map, Fairness) %>%
  summarize(pct.bid.zero = 100*round(sum(is.na(EffortWithNAs))/n(), 2),
            avg.positive.bid = mean(EffortWithNAs, na.rm = T),
            avg.bid          = mean(Effort))
pct.zero.dis.adv.w.learning


pct.zero <- long_df %>% filter(Period <= 24 & Period >= 15) %>%
  group_by(District) %>% summarize(pct.bid.zero = round(sum(Effort == 0)/n(), 2))
pct.zero

## Likelihood of winning based on observed averages
win.prob.advantaged <- 1 - ((37)/(37+38))^2
win.prob.advantaged
```
```{r Table_2_District_Stats_02.05.2022, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
##
district_stats_no_learnig <- df_clean %>%
  filter(Period >= 15, Period <= 24) %>%
  mutate(District.compare = ifelse((District == "EDG" & Player == 'A')|(District == "ELG" & Player == 'B'), "DG Player A to LG Player B",
                                   ifelse((District == "ELG" & Player == 'A')|(District == "EDG" & Player == 'B'), "LG Player A to DG Player B", "W for Both Players")),
          Advantage = ifelse((Player == "A" & Map == 5)|(Player == "B" & Map == 1), "Adv",
                            ifelse((Player == "B" & Map == 5)|(Player == "A" & Map == 1),"Dis.adv", "fair")))

district_stats_no_learnig <- district_stats_no_learnig %>%
  mutate(Adv.District.Names = ifelse((Map == 1 & District == "EDG" & Player == "B")|(Map == 5 & District == "ELG" & Player == "A"), "Two Partisan For",
                                     ifelse((Map == 1 & District == "ELG" & Player == "B")|(Map == 5 & District == "EDG" & Player == "A"), "Three Partisan Against",
                                            ifelse((Map == 1 & District == "EW" & Player == "B")|(Map == 5 & District == "EW" & Player == "A"),"One Partisan For", "Error"))),

         Disadv.District.Names = ifelse((Map == 1 & District == "EDG" & Player == "A")|(Map == 5 & District == "ELG" & Player == "B"), "Two Partisan Against",
                                     ifelse((Map == 1 & District == "ELG" & Player == "A")|(Map == 5 & District == "EDG" & Player == "B"), "Three Partisan For",
                                            ifelse((Map == 1 & District == "EW" & Player == "A")|(Map == 5 & District == "EW" & Player == "B"),"One Partisan Against", "Error"))))
##

district_stats_no_learnig_table <- district_stats_no_learnig %>%
  filter(Period >= 15, Period <= 24) %>%
  mutate(Fairness = ifelse((Player == "A" & Map == 5)|(Player == "B" & Map == 1), "Adv", 
                           ifelse((Player == "B" & Map == 5)|(Player == "A" & Map == 1),"Dis.adv", "fair")),
         Map.new = ifelse(Map == 1 |Map == 5, "gerry", Map),
         EffortWithNAs = ifelse(Effort == 0, NA, Effort),
         District.compare = ifelse((Map == 1 & Player == "B")|(Map == 5 & Player == "A"), Adv.District.Names,
                                   ifelse((Map == 1 & Player == "A")|(Map == 5 & Player == "B"), Disadv.District.Names, District.compare))
         ) %>%
  group_by(District.compare, Map.new, Fairness) %>%
  summarize(pct.bid.zero = 100*round(sum(is.na(EffortWithNAs))/n(), 2),
            avg.positive.bid = round(mean(EffortWithNAs, na.rm = T)),
            avg.bid          = round(mean(Effort)))

# Manually transfer stats to LaTex table
district_stats_no_learnig_table
```

```{r Time_Series_by_district_in_each_map, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
ts.each.map.each.dist <- df_clean %>% 
  dplyr::select(Session, Period, subject.id, Player, Map, District, Effort) %>% 
  mutate(District.compare = ifelse((District == "EDG" & Player == 'A')|(District == "ELG" & Player == 'B'), "DG Player A to LG Player B",
                                   ifelse((District == "ELG" & Player == 'A')|(District == "EDG" & Player == 'B'), "LG Player A to DG Player B", "W for Both Players")),
          Advantage = ifelse((Player == "A" & Map == 5)|(Player == "B" & Map == 1), "Adv",
                            ifelse((Player == "B" & Map == 5)|(Player == "A" & Map == 1),"Dis.adv", "fair")))

ts.each.map.each.dist <- ts.each.map.each.dist %>%
  mutate(Adv.District.Names = ifelse((Map == 1 & District == "EDG" & Player == "B")|(Map == 5 & District == "ELG" & Player == "A"), "Two Partisan For",
                                     ifelse((Map == 1 & District == "ELG" & Player == "B")|(Map == 5 & District == "EDG" & Player == "A"), "Three Partisan Against",
                                            ifelse((Map == 1 & District == "EW" & Player == "B")|(Map == 5 & District == "EW" & Player == "A"),"One Partisan For", "Error"))),

         Disadv.District.Names = ifelse((Map == 1 & District == "EDG" & Player == "A")|(Map == 5 & District == "ELG" & Player == "B"), "Two Partisan Against",
                                     ifelse((Map == 1 & District == "ELG" & Player == "A")|(Map == 5 & District == "EDG" & Player == "B"), "Three Partisan For",
                                            ifelse((Map == 1 & District == "EW" & Player == "A")|(Map == 5 & District == "EW" & Player == "B"),"One Partisan Against", "Error"))))
##
ts.each.map.each.dist <- ts.each.map.each.dist %>%
  filter(Period >= 15, Period <= 24) %>%
  mutate(Fairness = ifelse((Player == "A" & Map == 5)|(Player == "B" & Map == 1), "Adv", 
                           ifelse((Player == "B" & Map == 5)|(Player == "A" & Map == 1),"Dis.adv", "fair")),
         Map.new = ifelse(Map == 1 |Map == 5, "gerry", Map),
         EffortWithNAs = ifelse(Effort == 0, NA, Effort),
         District.compare = ifelse((Map == 1 & Player == "B")|(Map == 5 & Player == "A"), Adv.District.Names,
                                   ifelse((Map == 1 & Player == "A")|(Map == 5 & Player == "B"), Disadv.District.Names, District.compare))
         )

# Light grey line for Light Gray district, Dark grey line for Dark gray district, dashed line for white district
# (we could make background different color to use a white line, but that'd look bad in black and white print)
ts.each.map.each.dist <- ts.each.map.each.dist %>%
  mutate(Map = ifelse((Map == 1 & Player == "B")|(Map == 5 & Player =="A"), "Gerry Advantaged",
                      ifelse((Map == 1 & Player == "A")|(Map == 5 & Player == "B"),"Gerry Disadvantaged",
                             ifelse(Map == 2, "Symm_1_1",
                                    ifelse(Map == 3, "Symm_1_3", "Symm_3_1")))),
         District = ifelse(District == "EDG", "Dark Gray",
                           ifelse(District == "ELG", "Light Gray", 
                                  ifelse(District == "EW","White", "Wrong"))))

for.plot.of.ts.each.map.and.district <- ts.each.map.each.dist %>%  filter(Period >= 15, Period <=24) %>% group_by(Period, Map, District.compare) %>% summarise(avg.Effort = mean(Effort))

# For Figure 3 please make the following cosmetic changes: a) make the lines thinner √, b) make white dot dot rather than dash dot √, c) make background white not gray , d) remove the labels from inside the figure and put labels on the panels, e) put just gerrymandered treatments on first row and sym treatments on second row with each row centered, f) Use treatment names as shown in Table 2.

ts.by.map.and.district.gerry.adv <- for.plot.of.ts.each.map.and.district %>%
  filter(Map == "Gerry Advantaged") %>%
  ggplot(aes(x=Period, y=avg.Effort, group = District.compare, color = District.compare)) +
  geom_line(aes(linetype=District.compare)) +
  scale_linetype_manual(values=c("dotted", "solid","solid")) +
  scale_color_manual(values=c('#333333', '#000000','#999999'))+
  xlim(1,10) + ylim(0,60) + ylab("Expenditure") +
  scale_x_discrete(breaks=c(1:10)) +
  theme_bw() +  #drop a mostly white theme on for contrast
  theme(panel.border = element_rect(fill=NA, colour = "black", size=1), legend.title = element_blank(), legend.position="none", text = element_text(size = 12))

ts.by.map.and.district.gerry.disadv <- for.plot.of.ts.each.map.and.district %>%
  filter(Map == "Gerry Disadvantaged") %>%
  ggplot(aes(x=Period, y=avg.Effort, group = District.compare, color = District.compare)) +
  geom_line(aes(linetype=District.compare)) +
  scale_linetype_manual(name = "District",labels = c("White", "Dark Gray", "Light Gray"), values=c("dotted", "solid","solid")) +
  scale_color_manual(guide = F,labels = c("White", "Dark Gray", "Light Gray"), values=c('#333333', '#999999','#000000'))+
  xlim(1,10) + ylim(0,60) + ylab("Expenditure") +
  scale_x_discrete(breaks=c(1:10)) +
  theme_bw() +  #drop a mostly white theme on for contrast
  theme(panel.border = element_rect(fill=NA, colour = "black", size=1), legend.position="right", text = element_text(size = 12)) 

ts.by.map.and.district.sym11 <- for.plot.of.ts.each.map.and.district %>%
  filter(Map == "Symm_1_1") %>%
  ggplot(aes(x=Period, y=avg.Effort, group = District.compare, color = District.compare)) +
  geom_line(aes(linetype=District.compare)) +
  scale_linetype_manual(values=c("solid", "solid","dotted")) +
  scale_color_manual(values=c('#000000', '#333333','#999999'))+
  xlim(1,10) + ylim(0,60) + ylab("Expenditure") +
  scale_x_discrete(breaks=c(1:10)) +
  theme_bw() +  #drop a mostly white theme on for contrast
  theme(panel.border = element_rect(fill=NA, colour = "black", size=1), legend.title = element_blank(), legend.position="none", text = element_text(size = 12))

ts.by.map.and.district.sym13 <- for.plot.of.ts.each.map.and.district %>%
  filter(Map == "Symm_1_3") %>%
  ggplot(aes(x=Period, y=avg.Effort, group = District.compare, color = District.compare)) +
  geom_line(aes(linetype=District.compare)) +
  scale_linetype_manual(values=c("solid", "solid","dotted")) +
  scale_color_manual(values=c('#000000', '#333333','#999999'))+
  xlim(1,10) + ylim(0,60) + ylab("Expenditure") +
  scale_x_discrete(breaks=c(1:10)) +
  theme_bw() +  #drop a mostly white theme on for contrast
  theme(panel.border = element_rect(fill=NA, colour = "black", size=1), legend.title = element_blank(), legend.position="none", text = element_text(size = 12))

ts.by.map.and.district.sym13.alternative <- for.plot.of.ts.each.map.and.district %>%
  filter(Map == "Symm_1_3") %>%
  ggplot(aes(x=Period, y=avg.Effort, group = District.compare, color = District.compare)) +
  geom_line(aes(linetype=District.compare)) +
  scale_linetype_manual(values=c("solid", "solid","dotted")) +
  scale_color_manual(values=c('#000000', '#333333','#999999'))+
  xlim(1,10) + ylim(0,60) + ylab("Expenditure") +
  scale_x_discrete(breaks=c(1:10)) +
  theme_bw() +  #drop a mostly white theme on for contrast
  theme(panel.border = element_rect(fill=NA, colour = "black", size=1), legend.title = element_blank(), legend.position="none", text = element_text(size = 12))

ts.by.map.and.district.sym31 <- for.plot.of.ts.each.map.and.district %>%
  filter(Map == "Symm_3_1") %>%
  ggplot(aes(x=Period, y=avg.Effort, group = District.compare, color = District.compare)) +
  geom_line(aes(linetype=District.compare)) +
  scale_linetype_manual(values=c("solid", "solid","dotted")) +
  scale_color_manual(values=c('#000000', '#333333','#999999'))+
  xlim(1,10) + ylim(0,60) + ylab("Expenditure") +
  scale_x_discrete(breaks=c(1:10)) +
  theme_bw() +  #drop a mostly white theme on for contrast
  theme(panel.border = element_rect(fill=NA, colour = "black", size=1),legend.title = element_blank(), legend.position="none", text = element_text(size = 12))

# saved with width 300 height 175
ts.by.map.and.district.gerry.adv
ts.by.map.and.district.gerry.disadv # only one with 300 and 210
ts.by.map.and.district.sym11
ts.by.map.and.district.sym13
#ts.by.map.and.district.sym13.alternative
ts.by.map.and.district.sym31
```


## 3

Regression like Model 3, but only with data from the last 5 periods of Stage 1 (6 - 10). The only explanatory should be Adv, Disadv, Symm_1_3, Symm_3_1, and a constant. Standard errors should be clustered at the session level and we should include subject fixed effects.

Test that Disadv = Adv and that Symm_1_3 = Symm_3_1.

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
regress_df <- df %>% dplyr::select(Session, Period, Subject, Player, TE_1:TE_5) %>%
  filter(Period >= 20 & Period <= 24) %>%
  gather(Map, Effort, TE_1:TE_5)


regress_df <- regress_df %>% mutate(subject.id = as.character(Session*8-(8-Subject)),
                                    Player_B = ifelse(Player== "B", 1, 0),
         Gerry_B = ifelse(Map == "TE_1", 1, 0),
         Symm_1_1 = ifelse(Map == "TE_2", 1, 0),
         Symm_1_3 = ifelse(Map == "TE_3", 1, 0),
         Symm_3_1 = ifelse(Map == "TE_4", 1, 0),
         Gerry_A = ifelse(Map == "TE_5", 1, 0),
         Adv = ifelse((Map == "TE_1" & Player == "B")|(Map == "TE_5" & Player == "A"), 1,0),
         Disadv = ifelse((Map == "TE_1" & Player == "A")|(Map == "TE_5" & Player == "B"), 1,0),
         Stage_2_indicator = ifelse((Period > 24 & Period < 28), 1, 0))

regress_df$Session <- as.character(regress_df$Session)

# Set the data up as a panel
d_panel <- pdata.frame(regress_df, index=c("subject.id"))
# Run the model_four
model_four <- plm(Effort ~ Adv + Disadv + Symm_1_3 + Symm_3_1, data=regress_df, 
                  index = "subject.id", 
                  effect = "individual")

summary(model_four, cluster = "Session")

linearHypothesis(model_four, c("Adv + Disadv = 0"))
linearHypothesis(model_four, c("Symm_1_3 + Symm_3_1 = 0"))
# model_four <- lm(
#   Effort ~ Adv + Disadv + Symm_1_3 + Symm_3_1 + subject.id,
#   data = regress_df
#   )
# 
# summary(model_four, cluster = "Session")
stargazer(model_four, title = "Model 4 Regression Results", label = "Tab:regression_4", single.row = T)
```


## Additions on August 4, 2021

# 1 and 2

The average [total] bid by an advantaged player on a gerrymandered map in the last 5 periods of stage 1.

The average bid by a disadvantaged player on a gerrymandered map in the last 5 periods of stage 1.

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
new.stage.1 <- df %>%
  filter(Period <= 24 & Period >= 20) %>%
  dplyr::select(Session, Period, Subject, Player, TE_5,TE_1) %>%
  gather(Map, Effort, TE_5:TE_1) %>%
  mutate(advantage = ifelse((Player == "A" & Map == "TE_5")|(Player == "B" & Map == "TE_1"),"y","n"))

new.stage.1 %>%
  group_by(advantage) %>%
  summarise(avg.bid.by.gerry = mean(Effort))
```


# 3 

The percentage of times the advantaged player actually won on gerrymandered maps periods 1-10 and periods 6-10.

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
pct.actually.win <- df %>%
  filter(Period <= 24 & Period >= 15) %>%
  dplyr::select(Session, Period, Player, Win1, Win5) %>%
  gather(Map, Result, Win1:Win5) %>%
  mutate(advantage = ifelse((Player == "A" & Map == "Win5")|(Player == "B" & Map == "Win1"),"y","n"))

adv.a.win.pct <- pct.actually.win %>%
  filter(Map == "Win5", Player == "A") %>%
  mutate(adv.win = ifelse(Result == 1, 1, 0))

adv.b.win.pct <- pct.actually.win %>%
  filter(Map == "Win1", Player == "B") %>%
  mutate(adv.win = ifelse(Result == 1, 1, 0))

pct.win <- rbind(adv.a.win.pct, adv.b.win.pct)

# sum(pct.win$adv.win)/nrow(pct.win)
```


For Appendix:

Difference between Stage 1 and Stage 2

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
stage_1to2_regression_data <- df %>% dplyr::select(Session, Period, Subject, Player, TE_1:TE_5) %>%
  filter(Period >= 15 & Period <= 27) %>%
  gather(Map, Effort, TE_1:TE_5)

stage_1to2_regression_data <- stage_1to2_regression_data %>% mutate(subject.id = as.factor(Session*8-(8-Subject)),
                                    Player_B = ifelse(Player== "B", 1, 0),
         Gerry_B = ifelse(Map == "TE_1", 1, 0),
         Symm_1_1 = ifelse(Map == "TE_2", 1, 0),
         Symm_1_3 = ifelse(Map == "TE_3", 1, 0),
         Symm_3_1 = ifelse(Map == "TE_4", 1, 0),
         Gerry_A = ifelse(Map == "TE_5", 1, 0),
         Adv = ifelse((Map == "TE_1" & Player == "B")|(Map == "TE_5" & Player == "A"), 1,0),
         Disadv = ifelse((Map == "TE_1" & Player == "A")|(Map == "TE_5" & Player == "B"), 1,0),
         Stage_2_indicator = ifelse((Period > 24 & Period < 28), 1, 0))

##########
#map_impact_on_stage_1_no_learning <-lm(Effort ~ Adv + Disadv + Symm_1_3 + Symm_3_1, data = stage_1_regression_data)

#map_impact_on_stage_1_with_learning <-lm(Effort ~ Adv + Disadv + Symm_1_3 + Symm_3_1, data = stage_1_regression_data_with_learnng)
########

# Look at subject Fixed Effects and standard errors clustered at session level
########
map_impact_on_stage_1to2_no_learning_FE <-lm(Effort ~ Adv + Disadv + Symm_1_3 + Symm_3_1 + Stage_2_indicator + Stage_2_indicator*Adv + Stage_2_indicator*Disadv + Stage_2_indicator*Symm_1_3 + Stage_2_indicator*Symm_3_1 + subject.id, data = stage_1to2_regression_data)

summary(map_impact_on_stage_1to2_no_learning_FE)

stage_1to2_regression_data_with_learning <- stage_1to2_regression_data %>% filter(Period >= 20)
map_impact_on_stage_1to2_with_learning_FE <-lm(Effort ~ Adv + Disadv + Symm_1_3 + Symm_3_1 + Stage_2_indicator + Stage_2_indicator*Adv + Stage_2_indicator*Disadv + Stage_2_indicator*Symm_1_3 + Stage_2_indicator*Symm_3_1 + subject.id, data = stage_1to2_regression_data_with_learning)
summary(map_impact_on_stage_1to2_with_learning_FE)

##########
#summary(map_impact_on_stage_1_no_learning)
#summary(map_impact_on_stage_1_with_learning)
#summary(map_impact_on_stage_1_no_learning_FE)
#summary(map_impact_on_stage_1_with_learning_FE)

#stargazer(map_impact_on_stage_1_no_learning, map_impact_on_stage_1_with_learning, title = "Map Impact on Stage 1 Bidding", column.labels = c("w/out learning", "w/ learning"), label = "Tab:stage_1_with_and_without_learning", single.row = T)

stargazer(map_impact_on_stage_1to2_no_learning_FE,
          map_impact_on_stage_1to2_with_learning_FE,
          title = "Map Impact with Stage 2 Indicator (FE and Clustereed SE)",
          column.labels = c("w/out learning", "w/ learning"),
          label = "Tab:stage_1to2_with_and_without_learning_FE_CSE",
          omit = "subject.id", single.row = T)

# Must fill in clustered SE manually; can't figure out how to do this in Stargazer
map_impact_on_stage_1to2_no_learning_FE_cluster <- lm.cluster(Effort ~ Adv + Disadv + Symm_1_3 + Symm_3_1 + Stage_2_indicator + Stage_2_indicator*Adv + Stage_2_indicator*Disadv + Stage_2_indicator*Symm_1_3 + Stage_2_indicator*Symm_3_1 + subject.id, cluster = "Session", data = stage_1to2_regression_data)
summary(map_impact_on_stage_1to2_no_learning_FE_cluster)
#summary(reg,cluster = c("class_id"))

map_impact_on_stage_1to2_with_learning_FE_cluster <- lm.cluster(Effort ~ Adv + Disadv + Symm_1_3 + Symm_3_1 + Stage_2_indicator + Stage_2_indicator*Adv + Stage_2_indicator*Disadv + Stage_2_indicator*Symm_1_3 + Stage_2_indicator*Symm_3_1 + subject.id, cluster = "Session", data = stage_1to2_regression_data_with_learning)
summary(map_impact_on_stage_1to2_with_learning_FE_cluster)

# Tests with NO LEARNING
linearHypothesis(map_impact_on_stage_1_no_learning_FE, c("Adv = Disadv"))
#linearHypothesis(map_impact_on_stage_1_no_learning_FE, c("Symm_1_3 = 0"))
linearHypothesis(map_impact_on_stage_1_no_learning_FE, c("Symm_1_3 = 10"))
#linearHypothesis(map_impact_on_stage_1_no_learning_FE, c("Symm_3_1 = 0"))
linearHypothesis(map_impact_on_stage_1_no_learning_FE, c("Symm_3_1 = 10"))
linearHypothesis(map_impact_on_stage_1_no_learning_FE, c("Symm_1_3 = Symm_3_1"))

# Simultaneous testing without learning
linearHypothesis(map_impact_on_stage_1to2_no_learning_FE, c("Adv:Stage_2_indicator = 0",
                                                            "Disadv:Stage_2_indicator = 0",
                                                            "Symm_1_3:Stage_2_indicator = 0",
                                                            "Symm_3_1:Stage_2_indicator = 0"))

# Tests WITH LEARNING
linearHypothesis(map_impact_on_stage_1_with_learning, c("Adv = Disadv"))
#linearHypothesis(map_impact_on_stage_1_with_learning, c("Symm_1_3 = 0"))
linearHypothesis(map_impact_on_stage_1_with_learning, c("Symm_1_3 = 10"))
#linearHypothesis(map_impact_on_stage_1_with_learning, c("Symm_3_1 = 0"))
linearHypothesis(map_impact_on_stage_1_with_learning, c("Symm_3_1 = 10"))
linearHypothesis(map_impact_on_stage_1_with_learning, c("Symm_1_3 = Symm_3_1"))

# Simultaneous testing with learning
linearHypothesis(map_impact_on_stage_1to2_with_learning_FE, c("Adv:Stage_2_indicator = 0",
                                                            "Disadv:Stage_2_indicator = 0",
                                                            "Symm_1_3:Stage_2_indicator = 0",
                                                            "Symm_3_1:Stage_2_indicator = 0"))


linearHypothesis(map_impact_on_stage_1to2_no_learning_FE_cluster, c("Adv:Stage_2_indicator = 0",
                                                            "Disadv:Stage_2_indicator = 0",
                                                            "Symm_1_3:Stage_2_indicator = 0",
                                                            "Symm_3_1:Stage_2_indicator = 0"))

linearHypothesis(map_impact_on_stage_1to2_with_learning_FE_cluster, c("Adv:Stage_2_indicator = 0",
                                                            "Disadv:Stage_2_indicator = 0",
                                                            "Symm_1_3:Stage_2_indicator = 0",
                                                            "Symm_3_1:Stage_2_indicator = 0"))
```

## 01/07/2022

The appendix needs to have two things.  1) It should look at total expenditure differences by treatment in Stage 1 and Stage 2.  One thing to do would be to rerun the main regressions adding a Stage 2 dummy and the interaction of the Stage 2 dummy and each map.  We could use periods 1-13 and periods 6-13 mimicking what we do in the main text to control for early learning.  2) It should have the CDF comparisons that roles did not matter.  That is, player A in Sym11 White looks like Player B there, and so on for all 9 sym districts.  For the gerrymandered maps, the comparison is the advantaged in Map 1 vs the disadvantaged in Map 5 per district.  Then compare disadvantaged.  So we end up with 15 pairs of CDFs.  These should report the K-S tests that the distributions are the same and show the theoretical prediction as a vertical line.


