---
title: 'Gerrymandering: Exploring the Data'
author: "An, Anderson, and Deck"
date: "4/4/2021"
output: pdf_document
---

Definitely not the prettiest of graphics, but we can revisit the design. 

We first look at CDFs of bids for each district in each map for Players A and B.

Next we depict the modal map selection by each subject during stage 2 in a simple bar graph.

Lastly we depict the final stage distribution of map selection for the entire sample and by Player (A or B).


```{r setup, include=FALSE, warning=F, message=F}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(ggplot2)
library(dplyr)

# read in all data files for sessions 1 through 8
for(i in 1:8) {
  x <- read_excel(paste("Cleaned_Raw_Session_0", i, ".xlsx", sep = "")) %>% dplyr::select(
    Session, Period, Subject, Player, LType, Map_Selection = Map, EDG5:EW1, TE1:TE5
  ) 
 nam <- paste("df", i, sep = "_")
 assign(nam, x)
}

# combine data vertically
df <- rbind(df_1, df_2, df_3, df_4, df_5, df_6, df_7, df_8)
# library(tidyr)
# long_df <- df %>% gather(District, Effort, EDG5:EW1)
df <- df %>% rename(
  EDG_5 = EDG5, EDG_4 = EDG4, EDG_3 = EDG3, EDG_2 = EDG2, EDG_1 = EDG1,
  ELG_5 = ELG5, ELG_4 = ELG4, ELG_3 = ELG3, ELG_2 = ELG2, ELG_1 = ELG1,
  EW_5  = EW5, EW_4  = EW4, EW_3  = EW3, EW_2  = EW2, EW_1  = EW1,
  TE_5 = TE5, TE_4 = TE4, TE_3 = TE3, TE_2 = TE2, TE_1 = TE1
)
library(tidyr)
long_df <- df %>% dplyr::select(Session, Period, Subject, Player, LType, EDG_5:EW_1) %>% gather(District, Effort, EDG_5:EW_1)

long_df_map <- data.frame(lapply(long_df, function(x) {
  gsub("EDG5", "EDG_5", x)
}))

long_df_map <- data.frame(lapply(long_df_map, function(x) {
  gsub("EDG4", "EDG_4", x)
}))

long_df_map <- data.frame(lapply(long_df_map, function(x) {
  gsub("EDG3", "EDG_3", x)
}))

long_df_map <- data.frame(lapply(long_df_map, function(x) {
  gsub("EDG2", "EDG_2", x)
}))

long_df_map <- data.frame(lapply(long_df_map, function(x) {
  gsub("EDG1", "EDG_1", x)
}))
##########################
long_df_map <- data.frame(lapply(long_df_map, function(x) {
  gsub("ELG5", "ELG_5", x)
}))

long_df_map <- data.frame(lapply(long_df_map, function(x) {
  gsub("ELG4", "ELG_4", x)
}))

long_df_map <- data.frame(lapply(long_df_map, function(x) {
  gsub("ELG3", "ELG_3", x)
}))

long_df_map <- data.frame(lapply(long_df_map, function(x) {
  gsub("ELG2", "ELG_2", x)
}))

long_df_map <- data.frame(lapply(long_df_map, function(x) {
  gsub("ELG1", "ELG_1", x)
}))
##########################
long_df_map <- data.frame(lapply(long_df_map, function(x) {
  gsub("EW5", "EW_5", x)
}))

long_df_map <- data.frame(lapply(long_df_map, function(x) {
  gsub("EW4", "EW_4", x)
}))

long_df_map <- data.frame(lapply(long_df_map, function(x) {
  gsub("EW3", "EW_3", x)
}))

long_df_map <- data.frame(lapply(long_df_map, function(x) {
  gsub("EW2", "EW_2", x)
}))

long_df_map <- data.frame(lapply(long_df_map, function(x) {
  gsub("EW1", "EW_1", x)
}))
##########################

# Orderly data with district, Map, and effort amount for each subject each period in each session
df_clean <- long_df_map %>% separate(District, c("District", "Map"))

# get some interesting tables
avg.bid.map.district <- df_clean %>% group_by(Map, District) %>% summarise(avg.Effort = mean(as.numeric(Effort)))
avg.bid.by.session <- df_clean %>% group_by(Session) %>% summarise(avg.Effort = mean(as.numeric(Effort)))
avg.bid.session.map.district <- df_clean %>% group_by(Session, Map, District) %>% summarise(avg.Effort = mean(as.numeric(Effort)))
# recall: periods 15 - 24 are Stage 1, 25-27 are Stage 2, and 28 is Stage 3
avg.bid.by.period <- df_clean %>% group_by(Period, Map, District) %>% summarise(avg.Effort = mean(as.numeric(Effort)))

# Let's consider just the competitive districts
df_comp <- df_clean %>% subset(District == "EW" | (District==c("EDG","ELG") & Map == 4))
avg.bid.comp.dist <- df_comp %>% group_by(Map, District) %>% summarise(avg.Effort = mean(as.numeric(Effort)))
avg.bid.comp.session <- df_comp %>% group_by(Session) %>% summarise(avg.Effort = mean(as.numeric(Effort)))
avg.bid.comp.session.map.dist <- df_comp %>% group_by(Session, Map, District) %>% summarise(avg.Effort = mean(as.numeric(Effort)))

##
# install.packages("ggpubr")
library(ggpubr)
theme_set(theme_pubr())
```

\newpage

Note that in Maps 1, 2, 3, and 5 the white district is the only competitive district in the sense that only the competition within the white district determines whether a subject wins that Map. The exception is Map 4 in which it is logical to bid in any district as no district is guaranteed a victor.

Map 1


```{r, message=F, echo=F}
g1.1 <- ggplot(df, aes(x = EDG_1)) + 
  stat_ecdf(geom = "step") + 
  facet_wrap(~Player) + 
  ggtitle("Bids in Dark Grey: Map 1")
g1.2 <- ggplot(df, aes(x = ELG_1)) + 
  stat_ecdf(geom = "step") + 
  facet_wrap(~Player) + 
  ggtitle("Bids in Light Grey: Map 1")
g1.3 <- ggplot(df, aes(x = EW_1)) + 
  stat_ecdf(geom = "step") + 
  facet_wrap(~Player) + 
  ggtitle("Bids in White: Map 1")

figure <- ggarrange(g1.1, g1.2, g1.3,
                    labels = c("A", "B", "C"),
                    ncol = 2, nrow = 2)
figure
```

\newpage
  
Map 2


```{r, message=F, echo=F}
g2.1 <- ggplot(df, aes(x = EDG_2)) + 
  stat_ecdf(geom = "step") + 
  facet_wrap(~Player) + 
  ggtitle("Bids in Dark Grey: Map 2")
g2.2 <- ggplot(df, aes(x = ELG_2)) + 
  stat_ecdf(geom = "step") + 
  facet_wrap(~Player) + 
  ggtitle("Bids in Light Grey: Map 2")
g2.3 <- ggplot(df, aes(x = EW_2)) + 
  stat_ecdf(geom = "step") + 
  facet_wrap(~Player) + 
  ggtitle("Bids in White: Map 2")

figure.2 <- ggarrange(g2.1, g2.2, g2.3,
                    labels = c("A", "B", "C"),
                    ncol = 2, nrow = 2)
figure.2
```

\newpage

Map 3


```{r, message=F, echo=F}
g3.1 <- ggplot(df, aes(x = EDG_3)) + 
  stat_ecdf(geom = "step") + 
  facet_wrap(~Player) + 
  ggtitle("Bids in Dark Grey: Map 3")
g3.2 <- ggplot(df, aes(x = ELG_3)) + 
  stat_ecdf(geom = "step") + 
  facet_wrap(~Player) + 
  ggtitle("Bids in Light Grey: Map 3")
g3.3 <- ggplot(df, aes(x = EW_3)) + 
  stat_ecdf(geom = "step") + 
  facet_wrap(~Player) + 
  ggtitle("Bids in White: Map 3")

figure.3 <- ggarrange(g3.1, g3.2, g3.3,
                    labels = c("A", "B", "C"),
                    ncol = 2, nrow = 2)
figure.3
```

\newpage

Map 4


```{r, message=F, echo=F}
g4.1 <- ggplot(df, aes(x = EDG_4)) + 
  stat_ecdf(geom = "step") + 
  facet_wrap(~Player) + 
  ggtitle("Bids in Dark Grey: Map 4")
g4.2 <- ggplot(df, aes(x = ELG_4)) + 
  stat_ecdf(geom = "step") + 
  facet_wrap(~Player) + 
  ggtitle("Bids in Light Grey: Map 4")
g4.3 <- ggplot(df, aes(x = EW_4)) + 
  stat_ecdf(geom = "step") + 
  facet_wrap(~Player) + 
  ggtitle("Bids in White: Map 4")

figure.4 <- ggarrange(g4.1, g4.2, g4.3,
                    labels = c("A", "B", "C"),
                    ncol = 2, nrow = 2)
figure.4
```

\newpage

Map 5


```{r, message=F, echo=F}
g5.1 <- ggplot(df, aes(x = EDG_5)) + 
  stat_ecdf(geom = "step") + 
  facet_wrap(~Player) + 
  ggtitle("Bids in Dark Grey: Map 5")
g5.2 <- ggplot(df, aes(x = ELG_5)) + 
  stat_ecdf(geom = "step") + 
  facet_wrap(~Player) + 
  ggtitle("Bids in Light Grey: Map 5")
g5.3 <- ggplot(df, aes(x = EW_5)) + 
  stat_ecdf(geom = "step") + 
  facet_wrap(~Player) + 
  ggtitle("Bids in White: Map 5")

figure.5 <- ggarrange(g5.1, g5.2, g5.3,
                    labels = c("A", "B", "C"),
                    ncol = 2, nrow = 2)
figure.5
```

\newpage

Recall, Player A should pick Map 5 and Player B should pick Map 1 if they are choosing the map that gives them the best chance of winning.

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
stage_2 <- df %>% subset(Period > 24 & Period < 28) %>% 
  dplyr::select(Session, Subject, Period, Player, Map_Selection) %>% 
  mutate(subject.id = Session*8-(8-Subject))

library(raster)
mode_df <- stage_2 %>% group_by(subject.id, Player) %>% 
  summarise(mode.map = modal(Map_Selection, ties = 'random'))

map_mode_bar <- ggplot(mode_df, aes(x=mode.map, fill = Player, color = Player)) + 
  geom_bar(width = 0.5, alpha = 0.5, position="identity")
map_mode_bar + ggtitle("Modal Map Selection in Stage 2")

# map_mode_hist <- ggplot(mode_df, aes(x=mode.map, fill = Player, color = Player)) + 
#   geom_histogram(alpha = 0.5, position="identity")
# map_mode_hist

# sum(mode_df$mode.map == 1)

```

\newpage

Notice, in the below figures the singular choice of -99 represents the individual (subject 4 from session 8) that excused themselves from the experiment during this part of their session. The first figure depicts the map choices during the final stage for all participants. The second figure is of interest because we might have spillover from the previous stage whereby participants choose the map they have been choosing without really paying attention to the implications...or they could just be flipping the coin that they are the "incumbent" after randomization occurs.

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
# Create "last_period" as an empty vector and extract period 28 from each sessions
last_period <-subset(df, Period=="28")

last_period$Map_Selection <- as.factor(last_period$Map_Selection)
last_period$Bug <- ifelse(last_period$Player == last_period$LType, "No", "Yes")

ggplot(last_period, aes(x=Map_Selection)) +
    stat_count(width = 0.5, alpha = 0.5, position="identity")

ggplot(last_period, aes(x=Map_Selection, fill = Player, color = Player)) +
    stat_count(width = 0.5, alpha = 0.5, position="identity")
```


\newpage

Now we are addressing:

1) For the map where they should be bidding on every region, I would like to see player A’s 3 CDFs overlaid on top of each other because there’s no reason for them to differ but it’s hard to tell in the version you sent. 

2) I would also like to see player B’s CDFs overlaid


```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
df_clean <- df_clean %>% mutate(subject.id = as.numeric(Session)*8-(8-as.numeric(Subject)))
df_map_4 <- df_clean %>% 
  filter(Map == 4) %>% 
  dplyr::select(Period, subject.id, Player, Map, District, Effort)
df_map_4_small <- df_map_4 %>%
  group_by(Period, Player, District) %>% summarise(avg.period.bid = mean(as.numeric(Effort)))
```

```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}

cdf_4 <- ggplot(df_map_4_small, aes(x=avg.period.bid, size = 1.5)) + stat_ecdf(aes(colour=District)) + facet_wrap(~Player) + guides(size = F)

cdf_4 + ggtitle("Map 4 CDF by Player and District")
```


3) Separately I would like to overlay player A and B’s CDFs for district 1 in the map where they bid on all districts since there’s no reason for these to differ. 


```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
cdf_4_DG <- ggplot(df_map_4_small %>% filter(District == "EDG"), aes(x=avg.period.bid, size = 1.5)) + stat_ecdf(aes(colour=Player)) + guides(size = F)

cdf_4_DG + ggtitle("Map 4 CDF Dark Gray District")
```


4) same as 3) for district 2.


```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
cdf_4_LG <- ggplot(df_map_4_small %>% filter(District == "ELG"), aes(x=avg.period.bid, size = 1.5)) + stat_ecdf(aes(colour=Player)) + guides(size = F)

cdf_4_LG + ggtitle("Map 4 CDF Light Gray District")
```


5) same as 3) for district 3.


```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
cdf_4_W <- ggplot(df_map_4_small %>% filter(District == "EW"), aes(x=avg.period.bid, size = 1.5)) + stat_ecdf(aes(colour=Player)) + guides(size = F)

cdf_4_W + ggtitle("Map 4 CDF White District")
```


6) & 7) On each of the two maps where the players are symmetric and only bidding on one district I would like to see their CDF‘s overlaid. 


```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
###############################################################################################
df_map_2 <- df_clean %>% 
  filter(Map == 2) %>% 
  dplyr::select(Period, subject.id, Player, Map, District, Effort)

df_map_3 <- df_clean %>% 
  filter(Map == 3) %>% 
  dplyr::select(Period, subject.id, Player, Map, District, Effort)
###############################################################################################
df_map_2_small <- df_map_2 %>%
  group_by(Period, Player, District) %>% summarise(avg.period.bid = mean(as.numeric(Effort)))

df_map_3_small <- df_map_3 %>%
  group_by(Period, Player, District) %>% summarise(avg.period.bid = mean(as.numeric(Effort)))
###############################################################################################
par(mfrow = c(1, 2))
# Bidding in Map 2 White District
cdf_2_W <- ggplot(df_map_2_small %>% filter(District == "EW"), aes(x=avg.period.bid, size = 1.5)) + stat_ecdf(aes(colour=Player)) + ggtitle("Map 2: White District") + guides(size = F)
cdf_2_W

# Bidding in Map 3 White District
cdf_3_W <- ggplot(df_map_3_small %>% filter(District == "EW"), aes(x=avg.period.bid, size = 1.5)) + stat_ecdf(aes(colour=Player)) + ggtitle("Map 3: White District") + guides(size = F)
cdf_3_W
```


8) Overlay the CDFs of the advantage player in map 1 and the advantage player in map 5.

9) Overlay the CDFs of the disadvantaged player in map 1 and the disadvantaged player in map 5. 


```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
###############################################################################################
# Player B is advantaged in Map 1
df_map_1 <- df_clean %>% 
  filter(Map == 1) %>% 
  dplyr::select(Period, subject.id, Player, Map, District, Effort)

# Player A is advantaged in Map 5
df_map_5 <- df_clean %>% 
  filter(Map == 5) %>% 
  dplyr::select(Period, subject.id, Player, Map, District, Effort)
###############################################################################################
df_map_1_small <- df_map_1 %>%
  group_by(Period, Player, District) %>% summarise(avg.period.bid = mean(as.numeric(Effort)))
df_map_5_small <- df_map_5 %>%
  group_by(Period, Player, District) %>% summarise(avg.period.bid = mean(as.numeric(Effort)))
###############################################################################################
cdf_1_W <- ggplot(df_map_1_small %>% filter(District == "EW"), aes(x=avg.period.bid, size = 1.5)) + stat_ecdf(aes(colour=Player)) + ggtitle("Map 1 (Advantage B): White District") + guides(size = F)
cdf_1_W
cdf_5_W <- ggplot(df_map_5_small %>% filter(District == "EW"), aes(x=avg.period.bid, size = 1.5)) + stat_ecdf(aes(colour=Player)) + ggtitle("Map 5 (Advantage A): White District") + guides(size = F)
cdf_5_W
###############################################################################################
# Overlay advantage in 1 with advantaged in 5
# so only keep Player A Map == 5 and Player B Map == 1
df_adv_overlay <- df_clean %>% 
  filter((Map == 1 | Map == 5)&District == "EW") %>% 
  dplyr::select(Period, subject.id, Player, Map, District, Effort) %>% 
  mutate(Advantage = ifelse((Player == "A" & Map == 5)|(Player == "B" & Map == 1), "Adv", "Dis.adv"))

df_adv_overlay <- df_adv_overlay %>%
  group_by(Period, Player, Advantage, District) %>% 
  summarise(avg.period.bid = mean(as.numeric(Effort)))
###############################################################################################
par(mfrow = c(1, 2))
cdf_adv_overlay <- ggplot(df_adv_overlay %>% filter(Advantage == "Adv"), 
                          aes(x=avg.period.bid, size = 1.5)) + 
  stat_ecdf(aes(colour=Player)) +
  ggtitle("Both Players Advantaged: White District") + guides(size = F)
cdf_adv_overlay

cdf_dis.adv_overlay <- ggplot(df_adv_overlay %>% filter(Advantage == "Dis.adv"), 
                          aes(x=avg.period.bid, size = 1.5)) + 
  stat_ecdf(aes(colour=Player)) +
  ggtitle("Both Players Disadvantaged: White District") + guides(size = F)
cdf_dis.adv_overlay
```


10) Assuming the two CDFs in 8) look the same and the two CDFs in 9) look the same, then make a combined advantaged CDF and a combined disadvantaged CDF and overlay those so we me can easily see how being advantaged matters.  


```{r, warning=F, message=F, echo=F, fig.width=10, fig.height=5}
cdf_adv_dis.adv_overlay <- ggplot(df_adv_overlay, 
                          aes(x=avg.period.bid, size = 1.5)) + 
  stat_ecdf(aes(colour=Advantage)) +
  ggtitle("Advnataged vs Disadvantaged") + guides(size = F)
cdf_adv_dis.adv_overlay
```

